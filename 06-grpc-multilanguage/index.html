<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
      <link rel="stylesheet" type="text/css" href="../_css/labs-sd.css">
      <link href="../_prettify/prettify.css" type="text/css" rel="stylesheet" />
      <script type="text/javascript" src="../_prettify/prettify.js"></script>
      <title>gRPC Multi-linguagem</title>
   </head>
   <body onload="prettyPrint()">
      <div class="contexto">
         <p>
            <a href="../index.html">Labs SD</a> &gt;
         </p>
      </div>
      <div class="titulo" id="1">
         <h1>gRPC Multi-linguagem</h1>
      </div>
      <div class="objectivos">
         <h2>Objetivos</h2>
         <ul>
            <li>Desenvolvimento de aplicações distribuídas com gRPC com múltiplas linguagens de programação.</li>
            <li>Em particular, desenvolvimento de uma aplicação em que o cliente é programado em Python e o servidor em Java.</li>
         </ul>
      </div>
      <div class="indice"></div>
      <div class="corpo">
      <h2 id="materiais-de-apoio-aula">Materiais de apoio à aula</h2>
      <ul>
         <li><a href="https://grpc.io/docs/languages/python/basics/">https://grpc.io/docs/languages/python/basics/</a></li>
      </ul>
      <h2 id="pr-requisitos">Pré-requisitos</h2>
      <ul>
         <li>Python 3.5+</li>
         <li>Packages: <a href="https://pypi.org/project/grpcio/">grpcio</a>, <a
               href="https://pypi.org/project/grpcio-tools/">grpcio-tools</a> e <a
               href="https://docs.python.org/3/library/venv.html">venv</a></li>
         </ul>
         <h2 id="setup-e-instala-o-das-packages">Setup e instalação das packages</h2>
         <ul>
            <li>Windows:</li>
            <ul>
               <li>Correr o seguinte comando para criar um ambiente virtual:
                  <pre class="prettyprint lang-java"><code>python -m venv .venv</code></pre>
               </li>
               <li>Correr o comando para ativar o ambiente virtual:
                  <pre class="prettyprint lang-java"><code>.venv\Scripts\activate</code></pre>
               </li>
               <li>Correr o comando para instalar a package grpcio:
                  <pre
                     class="prettyprint lang-java"><code>python -m pip <span class="hljs-keyword">install</span> grpcio</code></pre>
               </li>
               <li>Correr o comando para
                  instalar a package grpcio-tools:
                  <pre
                     class="prettyprint lang-java"><code>python -m pip <span class="hljs-keyword">install</span> grpcio-tools</code></pre>
               </li>
               <li>Correr o comando para
                  desativar o ambiente virtual:
                  <pre class="prettyprint lang-java"><code>deactivate</code></pre>
               </li>
            </ul>
            <li>Linux:</li>
            <ul>
               <li>Correr o seguinte comando para criar um ambiente virtual:
                  <pre class="prettyprint lang-java"><code>python -m venv .venv</code></pre>
               </li>
               <li>Correr o comando para ativar o ambiente virtual:
                  <pre class="prettyprint lang-java"><code>source .venv/bin/activate</code></pre>
               </li>
               <li>Correr o comando para instalar a package grpcio:
                  <pre
                     class="prettyprint lang-java"><code>python -m pip <span class="hljs-keyword">install</span> grpcio</code></pre>
               </li>
               <li>Correr o comando para
                  instalar a package grpcio-tools:
                  <pre
                     class="prettyprint lang-java"><code>python -m pip <span class="hljs-keyword">install</span> grpcio-tools</code></pre>
               </li>
               <li>Correr o comando para
                  desativar o ambiente virtual:
                  <pre class="prettyprint lang-java"><code>deactivate</code></pre>
               </li>
            </ul>
         </ul>
         <!--pre class="prettyprint lang-java"><span class="hljs-comment"># windows</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             &gt; python -m venv .venv
 &gt; .venv\Scripts\activate

 <span class="hljs-comment"># linux</span>
 $ python -m venv .venv
 $ source .venv/bin/activate

 python -m pip <span class="hljs-keyword">install</span> grpcio
python -m pip <span class="hljs-keyword">install</span> grpcio-tools-->

</pre>
      <h2 id="java-vs-python-grpc">Java vs Python gRPC</h2>
      <ol>
         <li>
            Começe por fazer <strong>Clone</strong> ou <strong>Download</strong> do código fonte do <a
               href="https://github.com/tecnico-distsys/example_grpc_multilanguage">grpc_example_multilanguage</a>.      
               <li>Analise as diferenças e as semelhanças entre os dois clientes <code>java</code> na pasta <strong>client</strong> e <code>python</code> na pasta <strong>python_code</strong>:</li>
               <ul>
               <li>
                  <p>Criação de stubs:</p>
                  <ul>
                     <li>
                        Java:
                        <pre class="prettyprint lang-java">  final ManagedChannel channel = ManagedChannelBuilder.forTarget(target).usePlaintext().build()<span class="hljs-comment">;</span>
  HelloWorldServiceGrpc.HelloWorldServiceBlockingStub stub = HelloWorldServiceGrpc.newBlockingStub(channel)<span class="hljs-comment">;</span>
</pre>
                     </li>
                     <li>
                        Python:
                        <pre class="prettyprint lang-java">  <span class="hljs-keyword">with</span> grpc.insecure_channel(<span class="hljs-string">'localhost:8080'</span>) <span class="hljs-keyword">as</span> channel:
      stub = pb2_grpc.HelloWorldServiceStub(channel)
</pre>
                     </li>
                  </ul>
               </li>
               <li>
                  <p>Chamadas aos procedimentos remotos:</p>
                  <ul>
                     <li>
                        Java:
                        <pre class="prettyprint lang-java">  HelloWorld.HelloRequest <span class="hljs-built_in">request</span> = HelloWorld.HelloRequest.newBuilder().setName(<span class="hljs-string">"friend"</span>).build();
  HelloWorld.HelloResponse <span class="hljs-built_in">response</span> = stub.greeting(<span class="hljs-built_in">request</span>);
</pre>
                     </li>
                     <li>
                        Python:
                        <pre class="prettyprint lang-java">  response = stub.greeting(pb2.HelloRequest(<span class="hljs-keyword">name</span>=<span class="hljs-string">'friend'</span>))
</pre>
                     </li>
                  </ul>
               </li>
            </ul>
            </li>
      </ol>
      <h2 id="exerc-cio">Exercício</h2>
      <ul>
         <li>O objetivo deste exercício é estender o comportamento de <a
               href="https://github.com/tecnico-distsys/example_grpc_addressbook">uma aplicação base</a> de modo a permitir que o cliente possa
            procurar contactos. Para tal, pretende-se acrescentar a essa aplicação a seguinte operação remota:
            <ul>
               <li><code>searchPerson</code> - recebe uma <code>string</code> que corresponde ao email de uma pessoa numa lista de contactos. Retorna a
                  informação que o servidor tem desse contacto, ou erro caso não tenha a informação do contacto indicado.
               </li>
            </ul>
         </li>
      </ul>
      <ol>
         <li>Faça <strong>Clone</strong> ou <strong>Download</strong> do código fonte <a
               href="https://github.com/tecnico-distsys/example_grpc_addressbook">example grpc addressbook</a>. O código base
            fornecido contém um servidor que mantém uma lista de contactos e permite ao cliente adicionar e
            listar
            contactos.</li>
         <li>Comece por criar um ambiente virtual na diretoria base seguindo as instruções da secção &quot;<i>Setup e instalação
               das
               packages</i>&quot;.</li>
         <li>Defina, implemente e experimente o procedimento remoto <code>searchPerson</code>:
            <ul>
               <li>
                  Existem três módulos: contract, server e client. Vamos começar na diretoria <strong>contract</strong>:
                  <ol>
                     <li>Aceda ao ficheiro .proto. Este ficheiro define as estruturas de dados e os procedimentos remotos.</li>
                     <li>
                        Cada procedimento necessita de uma mensagem de pedido e de uma mensagem de resposta:
                        <ul>
                           <li>Analise a mensagem do pedido <code>SearchPersonRequest</code>, que contém uma string que corresponde ao email do
                              contacto a
                              pesquisar.</li>
                           <li>Defina o procedimento rpc com o nome <code>searchPerson</code>, que recebe <code>SearchPersonRequest</code> e
                              devolve
                              <code>PersonInfo</code>.
                           </li>
                        </ul>
                     </li>
                     <li>
                        Vamos gerar código Java a partir dos protocol buffers. O Maven está configurado com plugins para chamar a ferramenta
                        protoc (protocol buffers compiler):
                        <ul>
                           <li>Execute o comando <code>mvn install</code> </li>
                           <li>Se tudo correr bem, as definições protobuf foram convertidas para classes Java, que foram compiladas e instaladas no repositório local do Maven.</li>
                        </ul>
                     </li>
                     <li>
                        Vamos gerar código Python a partir dos protocol buffers:
                        <ul>
                           <li>Execute o comando <code>mvn exec:exec</code></li>
                           <li>Caso tenha um alias diferente para o python, modifique o <a
                                 href="https://github.com/tecnico-distsys/example_grpc_addressbook/blob/main/contract/pom.xml#L85">executable do
                                 pom</a> para o seu alias e corra o comando de novo.</li>
                           <li>Verifique e analise os ficheiros gerados na diretoria
                              <code>generated-sources/protobuf/python</code>.
                           </li>
                        </ul>
                     </li>
                  </ol>
               </li>
               <li>
                  Vamos agora concretizar o <strong>server</strong>:
                  <ol>
                     <li>
                        Com base nas classes geradas pelo protoc e, por analogia com outros exemplos de servidores gRPC já vistos nas aulas de
                        laboratório anteriores,
                        ao ficheiro <code>AddressBookServiceImpl</code> adicione o método de implementação do <code>searchPerson</code>:
                        <pre class="prettyprint lang-java">   <span class="hljs-meta">@Override</span>
   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">searchPerson</span><span class="hljs-params">(SearchPersonRequest request, StreamObserver&lt;PersonInfo&gt; responseObserver)</span> </span>{
      //TODO: implement the search person feature
   }
</pre>
                     </li>
                     <li>Para compilar e testar, execute na diretoria <strong>server</strong> o comando <code>mvn compile exec:java</code>
                     </li>
                     </ol>
               </li>
               <li>
                  <p>Vamos concretizar o <strong>client</strong>:</p>
                  <ol>
                     <li>
                        <p>Adicione uma função ao cliente que pede o email a procurar e chamada o procedimento remoto <code>searchPerson</code>
                        </p>
                        <pre class="prettyprint lang-java">   <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PyhtonClient</span><span class="hljs-params">(object)</span>:</span>
   ...
   <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">search_person</span><span class="hljs-params">(self)</span>:</span>
      <span class="hljs-comment"># TODO: implement search person feature</span>
   ...
</pre>
                     </li>
                     <li>Para testar, execute na diretoria <strong>client</strong> o comando <code>python client.py</code></li>
                     </ol>
               </li>
            </ul>
         </li>
      </ol>
      
      <h2 id="compila-o-do-proto">Sobre a compilação do proto para Python  </h2>
      <ul>
         <li>O comando descrito abaixo gera 2 ficheiros .py na &lt;diretoria-output&gt; indicada: o &lt;nome-do-proto&gt;_pb2.py
            e o
            &lt;nome-do-proto&gt;_pb2_grpc.py com classes que representam os tipos de dados das mensagens e com classes de
            suporte ao servidor e ao cliente do RPC. Nos exemplos deste guião a compilação é automatizada com o Exec Maven
            Plugin.</li>
            <pre class="prettyprint lang-java">python -m grpc_tools.protoc -I&lt;pasta-para-o-contrato&gt; --python_out=&lt;diretoria-output&gt; --grpc_python_out=&lt;diretoria-output&gt; &lt;protos-para-compilar&gt;</pre>
         
      </ul>
      
     <div class="objectivos">    
         <h2>Atenção que na próxima semana há mini exercício!</h2>
    <p>
            Na próxima aula laboratorial (consultar o calendário das aulas laboratoriais), ser-lhe-á entregue uma alínea adicional que 
            estende a solução construída pelo guião acima.
                É, pois, esperado que, nessa aula, cada estudante traga este guião inteiramente resolvido.</p>
    </div>
      <p>&nbsp;</p>
      <hr />
      <div class="rodape">
         <p>
            &copy; Docentes de Sistemas Distribuídos,
            <a href="http://www.dei.tecnico.ulisboa.pt/">Dep. Eng. Informática</a>,
            <a href="http://www.ist.eu">Técnico Lisboa</a><br />
         </p>
      </div>
   </body>
</html>
