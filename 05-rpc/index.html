<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="../_css/labs-sd.css" />
	<link href="../_prettify/prettify.css" type="text/css" rel="stylesheet" />
	<script type="text/javascript" src="../_prettify/prettify.js"></script>
	<title>Invocação de procedimentos remotos com gRPC</title>
</head>

<body onload="prettyPrint()">
	<div class="contexto">
		<p>	<a href="../index.html">Labs SD</a> &gt;</p>
	</div>
	<div class="titulo" id="1">
		<h1>Invocação de procedimentos remotos com gRPC</h1>
	</div>
	<div class="objectivos">
		<h2>Objectivos da semana</h2>
		<ul>
			<li>Distribuir uma aplicação originalmente centralizada usando o gRPC</li>
			<li>Descrever, em detalhe, os componentes do sistema gRPC</li>
		</ul>
	</div>
	<div class="indice"></div>
	<div class="corpo">
		<h2 id="conteudos">Materiais de apoio à aula</h2>
		<p class="exemplos"></p>
		<ul>
			<li>	<a href="https://github.com/tecnico-distsys/example_grpc">gRPC Hello World <img src="../_img/github.png" alt="GitHub" height="16"></a>
				<br />Siga as instruções dos ficheiros	<tt>README.md</tt> para compilar e executar o exemplo.</li>
		</ul>
		<ul>
			<li>	<a href="https://grpc.io/docs/tutorials/basic/java.html">Tutorial de gRPC para Java</a>
			</li>
			<li>	<a href="https://grpc.io/grpc-java/javadoc/index.html">API de gRPC para Java</a>
			</li>
			<li>	<a href="https://developers.google.com/protocol-buffers/docs/overview">Documentação de 
						<i>Protocol Buffers</i>
					</a>
			</li>
		</ul>
		<p>&nbsp;</p>
		<p class="exercicios"></p>
		<h2 id="guiao">Exercício a resolver até ao fim da aula</h2>
		<p>Neste exercício iremos transformar uma implementação do Jogo do Galo (<i>Tic Tac Toe</i>) numa aplicação distribuída utilizando o gRPC.</p>
		<img src="./ttt.png" alt="Tic Tac Toe" height="90" />
		<br />
		<ol type="I">
			<li>Relembre o Jogo do Galo/<i>Tic Tac Toe</i> utilizado no laboratório anterior.
			<ol type="1">
				<li>Faça	<b>
							<i>Clone
							</b>
					</i>ou	<b>
							<i></i>Download
						</b>
					</i>do código fonte da	<a href="https://github.com/tecnico-distsys/example_ttt">implementação do jogo 
						<img src="../_img/github.png" alt="GitHub" height="16"/>
					</a></li>
				<li>Analise o código do jogo de forma a compreender a implementação.</li>
				<li>Compile e execute o código com o comando:
					<br />	<tt>mvn compile exec:java</tt>
					<br />
					<br />
				</li>
			</ol>
			<li>Pretende-se que a nova versão da aplicação seja dividida em dois processos: servidor e cliente, através do gRPC.
				<br />Vamos começar por estudar a tecnologia gRPC.
			<ol type="1">
				<li>Faça	<b>
						<i>Clone
						</b>
						</i>ou	<b>
						<i>Download</i>
					</b>
					</i>do código fonte da	<a href="https://github.com/tecnico-distsys/example_grpc">aplicação de exemplo com gRPC 
					<img src="../_img/github.png" alt="GitHub" height="16"/>
				</a>
				<br />
				</li>
				<li>Veja como a aplicação está estruturada em três módulos:	<i>contract</i>,	<i>server</i> e	<i>client</i>.
					<br />Cada módulo tem um POM próprio.
					<!--Existe um POM pai com definições partilhadas por todos os módulos.-->
				</li>
				<li>Execute o exemplo seguindo as instruções	<tt>README.md</tt> de cada módulo.
					<br />
				</li>
				<li>Comece pelo módulo	<tt>contract</tt>, executando o comando:
					<br />	<tt>mvn install</tt>
					<br />Este comando vai passar pela etapa	<i>generate-sources</i>, que vai invocar o	<i>protoc</i>, o compilador de	<i>protocol buffers</i> que vai gerar código Java para lidar com os tipos de dados descritos no ficheiro	<tt>.proto</tt>.
					<br />Familiarize-se com o código e tente responder às seguintes questões:
					<ol type="a">
						<li>Onde estão definidas as mensagens trocadas entre o cliente e o servidor?</li>
						<li>Onde estão definidas as operações remotas no servidor?</li>
						<li>Onde estão os ficheiros gerados pelo compilador de	<i>Protocol Buffers</i>?</li>
						<li>Onde são feitas as invocações remotas no cliente?</li>
						<li>As invocações remotas são síncronas (bloqueantes) ou assíncronas?</li>
						<!--li>
O que teria de alterar para que a resposta à pergunta anterior mudasse?
				</li-->
					</ol>
					<li>Abra uma consola e corra o servidor:</br>	<tt>mvn compile exec:java</tt>
					</li>
					<li>Abra uma outra consola e execute o cliente:
						<br />	<tt>mvn compile exec:java</tt>
						<br />Depois de ver o	<i>Hello World</i> a funcionar corretamente no seu computador, avance para o passo seguinte.
						<br />
						<br />
					</li>
			</ol>
			<li>Vamos agora transformar o Jogo do Galo numa aplicação cliente-servidor com gRPC organizada em três módulos, à semelhança do exemplo.
				<br />O contrato irá definir a interface remota, com detalhes sobre as mensagens a trocar. O servidor irá manter o estado do jogo (tabuleiro). O cliente irá ter a interface utilizador na consola.
				<br />
				<br />
			
			<ol type="1">
				<li>Faça	<b>
					<i>Clone</b>
					</i>ou	<b>
					<i></i>Download
				</b>
			</i>do <a href="https://github.com/tecnico-distsys/example_ttt"> código inicial do exercício</a>
				<img src="../_img/github.png" alt="GitHub" height="16"/>
			</li>
				<li>Baseando-se no módulo	<tt>contract</tt> da aplicação de exemplo, modifique o ficheiro	<tt>.proto</tt> com a definição das mensagens e procedimentos necessários para as invocações remotas das funções já definidas (	<tt>play</tt>,	<tt>checkWinner</tt> e	<tt>currentBoard</tt>). Sugestão: consulte a	<a href="https://developers.google.com/protocol-buffers/docs/overview">documentação dos 
					<i>Protocol Buffers</i></a>.
				<ol type="a">
					<li>Declare todas as mensagens de pedido e resposta para cada operação do jogo. Note que algumas mensagens podem ser vazias, mas devem ser declaradas na mesma.</li>
					<li>Cada campo deve ter uma etiqueta numérica única.</li>
					<li>Declare um serviço com as definições das operações necessárias, usando as mensagens definidas.</li>
					<li>Instale o módulo com o comando	<tt>mvn install</tt>. Analise o código Java gerado na pasta	<tt>target/generated-sources/</tt>.</li>
					<ol type="i">
						<li>Onde estão definidas as mensagens?</li>
						<li>E as operações?
							<br />
							<br />
						</li>
					</ol>
					</li>
				</ol>
				<li>Baseando-se no módulo	<tt>server</tt> da aplicação de exemplo, modifique o código inicial do módulo server.
					<ol type="a">
						<li>Confirme que o módulo contrato é uma dependência do projeto.</li>
						<li>Modifique a classe <tt>TTTServiceImpl</tt> de forma a implementar as operações remotas declaradas no contrato, utilizando a classe	<tt>TTTGame</tt> (que implementa a lógica do jogo) definida no código base. Esta classe estende a classe do serviço definido no contrato e faz <i>override</i> das operações declaradas no contrato.
							<br />Exemplo de um método:	<pre class="prettyprint lang-java">
	public class TTTServiceImpl extends TTTGrpc.TTTImplBase {
		private TTTGame ttt = new TTTGame();

		@Override
		public void currentBoard(CurrentBoardRequest request, StreamObserver&lt;CurrentBoardResponse&gt; responseObserver) {
			CurrentBoardResponse response = CurrentBoardResponse.newBuilder().setBoard(ttt.currentBoard()).build();
			responseObserver.onNext(response);
			responseObserver.onCompleted();
		}
	
</pre>
						</li>
						<li>Confirme que a classe <tt>TTTServer</tt> inicia um servidor numa porta que recebe como argumento, instanciando a classe modificada na alínea anterior.</li>
						<li>Tenha em conta que o acesso a variáveis partilhadas tem que ser	<a href="../03-tools-sockets/java-synch/index.html">sincronizado</a>.</li>
						<ol type="i">
							<li>Porque é que esta sincronização é necessária?</li>
							<li>Onde é que há possibilidade de concorrência?
								<br />
								<br />
							</li>
						</ol>
					</ol>
				</li>
				<li>Por fim, com base no módulo	<tt>client</tt> da aplicação de exemplo, modifique o código inicial do módulo client.
					<ol type="a">
						<li>Confirme que o módulo contrato é uma dependência do projeto.</li>
						<li>Confirme que a classe <tt>TTTClient</tt> instancia um <i>stub</i> do serviço TTT (através de um endereço e porta recebidos como argumentos).</li>
						<li>Usando o código do ficheiro	<tt>Game.java</tt> do código base, adicione métodos para jogar o jogo remotamente através do	<i>stub</i> instanciado.
							<br />Exemplo de adaptação:	<pre class="prettyprint lang-java">
	// before the change: local call
	winner = ttt.checkWinner();

	// after the change: remote call
	winner = stub.checkWinner(CheckWinnerRequest.getDefaultInstance()).getResult();
				</pre>
						</li>
					</ol>
				</li>
				<li>Lance o servidor e experimente jogar remotamente através do cliente construído.
					<br />
					<br />
				</li>
			</ol>
			<p>O resto do enunciado será entregue na aula.
				<br />O objectivo será estender a solução resultante do enunciado acima com mais procedimentos remotos ou modificar alguns dos seus procedimentos actuais.
				<br />
				<br />
			</p>
	</div>
	<div class="objectivos">
		<h2>Entrega da solução</h2>
		<p>Fénix, Avaliação, Projetos,	<b>mini Exercício 2 - gRPC</b>
		</p>
		<p>A solução completa deverá ser submetida no Fénix	<b>antes do fim da sua aula de laboratório</b>.
			<br />Trabalhos submetidos depois da hora de fim da aula não serão considerados.
			<br />
		</p>
		<p>	<b>Ter atenção ao seguinte:</b>
		</p>
		<ul>
			<li>Só serão aceites trabalhos de estudantes que estiveram presentes no laboratório.</li>
			<li>Assegure-se que a solução é enviada em formato ZIP e que não contém código compilado (faça	<tt>mvn clean</tt> antes de criar o zip)</li>
			<li>Deverá também incluir um ficheiro	<tt>README</tt> com resumo da funcionalidade implementada e com instruções para colocar a aplicação a funcionar como esperado.
				<br />Por exemplo:</li>
			<ul>
				<li>A funcionalidade pedida foi total/parcialmente implementada	<b>...</b>
				</li>
				<li>Para compilar:	<kbd>mvn compile</kbd>
				</li>
				<li>O servidor deve executar com o comando:	<kbd>mvn exec:java &amp;</kbd>
				</li>
				<li>O cliente deve executar com o comando:	<kbd>mvn exec:java -Dserver.port=8080</kbd>
				</li>
			</ul>
		</ul>
	</div>
	<hr />
	<div class="rodape">
		<p>&copy; Docentes de Sistemas Distribu&iacute;dos,	<a href="http://www.dei.tecnico.ulisboa.pt/">Dep. Eng. Informática</a>,	<a href="http://www.ist.eu">Técnico Lisboa</a>
			<br />
		</p>
	</div>
</body>
</html>