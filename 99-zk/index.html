<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
        <link rel="stylesheet" type="text/css" href="../_css/labs-sd.css">
        <link href="../_prettify/prettify.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="../_prettify/prettify.js"></script>
        <title>Apache ZooKeeper</title>
    </head>
    <body onload="prettyPrint()">
        <div class="contexto">
            <p>
                <a href="../index.html">Labs SD</a> &gt;
            </p>
        </div>
        <div class="titulo" id="1">
            <h1>Apache ZooKeeper</h1>
        </div>
        <div class="objectivos">
            <h2>Objetivos</h2>
            <ul>
								<li>Instalação da ferramenta ZooKeeper</li>
                <li>Publicar e pesquisar serviços no servidor de nomes ZooKeeper</li>
            </ul>
        </div>
        <div class="indice"></div>
        <div class="corpo">
        <h2>ZooKeeper</h2>
        <p>
O Apache ZooKeeper é um serviço centralizado para resolver nomes, fornecer informação de configuração e sincronizar conjuntos de servidores distribuídos.<br />

O seu objetivo é simplificar a gestão de serviços, com propagação fiável de alterações de configuração.

<br><br>
Mais informação:
<!--ul>
    <li--><a href="https://zookeeper.apache.org/documentation.html">ZooKeeper Documentation</a><!--/li>
</ul-->
						
        </p>
        <h3>Obtenção e Instalação</h3>
        <p>
            
        <li>Obter</li>
        <ul>
            <li>
                <a href="https://zookeeper.apache.org/">Apache ZooKeeper</a>
                <small>(versão <i>stable</i>)</small><br />
            </li>
			<li>
				Obtenha a versão pré-compilada.
				<small>(Versão com binários incluidos)</small>
				<li>exemplo: <i>apache-zookeeper-x.y.z-bin.tar.gz</i></li>
			</li>
        </ul>
        <li>Instalar
		<ul>
			<li>Descompactar para pasta à escolha.</li>
			<li>exemplo: <tt>/home/user/zookeeper</tt></li>
		</ul>
		</li>
			
        <li>Configurar</li>
        <ul>
            <li>Criar a pasta <i>data</i> dentro da pasta de instalação do ZooKeeper.
            	É nesta pasta que o ZooKeeper irá armazenar a informação.
			<ul>
				<li>exemplo: <i>/home/user/zookeeper/data</i></li>
			</ul>
			</li>
            <li>Mudar o nome do ficheiro <i>zookeeper/conf/zoo_sample.cfg</i> para <i>zoo.cfg</i> </li>
            <li>Editar o ficheiro <i>zoo.cfg</i>, alterando as seguintes configurações:
				<ul>
				<li>initLimit=10</li>
				<li>syncLimit=2</li>
				<li>dataDir=/home/user/zookeeper/data</li>
				</ul>
			<li>Repare no campo <i>clientPort</i>
				<ul>este é o porto em que o ZooKeeper estará disponivel</ul>
        </ul>
    
        </p>
		
		<h3>Utilização</h3>
		<p>
			Vamos agora iniciar o servidor do ZooKeeper.

			<ul>
				<li>Navegue até à pasta <i>zookeeper/bin</i></li>
				<li>Corra o comando <tt>./zkServer.sh start</tt></li>
				<li>Deverá obter o seguinte <i>output</i>:</li>
<pre class="prettyprint lang-bash">
    $ Starting zookeeper ... STARTED
</pre>
				<br>
				<li>O ZooKeeper está agora a correr.</li><br>
			</ul>

			Consola de interação com o servidor ZooKeeper

			<ul>
				<li>Novamente na pasta <i>zookeeper/bin</i>, corra o comando <tt>./zkCli.sh</tt></li>
				<ul><li>Este comando inicializa uma consola que permite interagir com o servidor ZooKeeper.</li></ul>
				<li>Na consola correr o comando <tt>ls /</tt></li>
				<ul>Este comando mostra os nós <i>zNodes</i> existentes na <i>raiz (/)</i> do ZooKeeper.</ul>
				<br>
				<li>Crie agora um novo nó com o comando <tt>create</tt></li>
				<ul><li>correr <tt>create /myFirstZnode myFirstData</tt></li>
					<li>Verificar que o nó foi criado com sucesso.</li>
				</ul>
				<li>Verifique que o nó criado contem os dados</li>
				<ul><li>correr o comando <tt>get /myFirstZnode</tt></li>
					<li>verificar os dados devolvidos</li>
				</ul>
				<br>

				<li>Vamos agora eliminar o nó criado</li>
				<ul>
					<li>correr o comand <tt>delete /myFirstNode</tt></li>
					<li>verificar com <tt>ls /</tt></li>
				</ul>

				<li>Para finalizar, correr <tt>quit</tt> para encerrar a consola do cliente.</li>

				<li>Para encerrar o servidor, corra o comando <tt>./zkServer.sh stop</tt></li>.</li>
				<br>
			</ul>
		</p>
		
<h3>Utilização do ZooKeeper para registo de serviços</h3>

<p>
Os endereços -- servidor e porto -- de serviços gRPC devem ser descobertos de forma dinâmica, para evitar que fiquem fixos no código das aplicações.
Isto permite que o endereço mude sempre que necessário, sem recompilação dos clientes.
Permite também que existam diversas réplicas de servidores para contactar alternativamente.
</p>

<p>
As funcionalidades do ZooKeeper vão para além de um simples servidor de nomes.
Para tornar a utilização do ZooKeeper mais simples foi criada a biblioteca <tt>ZKNaming</tt> que oferece as operações <tt>rebind</tt> e <tt>lookup</tt>.
Esta biblioteca torna o registo e pesquisa de serviços mais sucinto.
O código fonte está disponível para consulta e modificação, caso sejam necessárias mais funcionalidades do ZooKeeper.
</p>

Mais informação:
<!--ul>
    <li--><a href="zk-naming/apidocs/index.html">ZKNaming JavaDoc</a><!--/li>
</ul-->

<h3>Exercício</h3>

<p>
O objetivo do exercício desta aula é usar a biblioteca ZKNaming para que o servidor <tt>grpc-hello</tt> (da aula anterior) se registe no ZooKeeper.
</p>


<ol type="I">
		<li>Relembre o exemplo <i>gRPC HelloWorld</i> fornecido na aula anterior. </li>
		<br>
		<ol type="1">
			<li>
				Descarregue e descomprima o código fonte da <a href="./../04-rpc/grpc-hello-world.zip">aplicação de exemplo com gRPC <img src="../_img/zip.png" alt="ZIP" /></a>
			</li>
			<li>
				Analise o código para relembrar a implementação.
			</li>
			<li>
				Comece pelo módulo <tt>contract</tt>, e execute o comando:<br>
				<tt>mvn install</tt>
			</li>
			<li>
				Abra uma consola e corra o servidor:<br>
				<tt>mvn compile exec:java</tt>
			</li>
			<li>
				Abra outra consola e execute o cliente:<br>
				<tt>mvn compile exec:java</tt>
			</li>
		</ol>
		<br>

		<li>Vamos agora obter a biblioteca <tt>ZKNaming</tt> e instalar no repositório local do <tt>Maven</tt>.</li>
		<br>
		<ol type="1">
			<li>
				Obtenha o codigo da biblioteca <a href="./zk-naming.zip">zk-naming <span style="color:red;font-size:90%">[atualizado]</span><img src="../_img/zip.png" alt="ZIP" />  </a>
			</li>
			<li>
				Instalar o módulo no repositório Maven Local:<br>
				Atenção: Para correr os exemplos seguintes, é necessario que o servidor ZooKeeper já tenha sido iniciado: <tt>./path/to/zookeeper/bin/zkServer.sh start</tt>
				 <ol>
				 	<tt>cd zk-naming</tt> <br>
				 	<tt>mvn install</tt>
				 	<li>Uma vez instalado o módulo no repositório Maven local, a biblioteca pode ser usada como dependência em qualquer <tt>
				 	pom.xml</tt>. </li>
				 </ol>
			</li>
		</ol>
		<br>
		<li>Vamos agora adaptar o <i>gRPC HelloWorld</i> para uma aplicação cliente-servidor que utiliza a biblioteca <tt>ZKNaming</tt> para registar e procurar serviços distribuídos.</li>
		<ol type="1">
			<li>
				Observe o <tt>pom.xml</tt> do servidor HelloWorld:
				<ol>
					<li>Adicione a dependência para a biblioteca ZKNaming:</li>
					
					<pre class="prettyprint lang-xml">
...
&lt;!-- ZK Naming --&gt;
&lt;dependency&gt;
&lt;groupId&gt;pt.ulisboa.tecnico.sdis&lt;/groupId&gt;
&lt;artifactId&gt;zk-naming&lt;/artifactId&gt;
&lt;version&gt;1.0.2&lt;/version&gt;
&lt;/dependency&gt;
...
				</pre>
					<br>
					<li>
						Confirme as dependências, fazendo: <br/>
						<tt>mvn dependency:tree</tt>
					</li>
					<li>O servidor deverá receber como argumentos o endereço e porto do ZooKeeper, bem como o seu próprio <tt>host</tt>, <tt>port</tt> e nome, no formato:</li>
					<ol><li><tt>/HelloService</tt></li>
						<li>o argumento nome será referênciado no resto do exercício como <tt>path</tt>
					</ol>
					<pre class="prettyprint lang-xml">
...
&lt;properties&gt;
&lt;zoo.host&gt;localhost&lt;/zoo.host&gt;
&lt;zoo.port&gt;2181&lt;/zoo.port&gt;
&lt;server.host&gt;localhost&lt;/server.host&gt;
&lt;server.port&gt;8080&lt;/server.port&gt;
&lt;server.path&gt;/HelloService&lt;/server.path&gt;
...
...
&lt;mainClass&gt;${mainclass}&lt;/mainClass&gt;
	&lt;arguments&gt;
		&lt;argument&gt;${zoo.host}&lt;/argument&gt;
		&lt;argument&gt;${zoo.port}&lt;/argument&gt;
		&lt;argument&gt;${server.host}&lt;/argument&gt;
		&lt;argument&gt;${server.port}&lt;/argument&gt;
		&lt;argument&gt;${server.path}&lt;/argument&gt;
...					</pre>

				</ol>
			</li>
			<br>

			<li>
				Altere o código do servidor, de modo a chamar a biblioteca <tt>zk-naming</tt> para registar o seu <i>host</i> e <i>port</i>.
				<ol>
					<li>Adicionar as seguintes linhas de código ao servidor:</li>
					<pre class="prettyprint lang-java">
...
ZKNaming zkNaming = null;
try {
...
zkNaming = new ZKNaming(zooHost, zooPort);

// publish
zkNaming.rebind(path,host,port);

...
// start gRPC server
...
// await termination
...

} catch (Exception e) {
			System.out.printf("Caught exception: %s%n", e);

} finally  {
...
    if (zkNaming != null) {
        // remove
        zkNaming.unbind(path,host,port);
    }
...
}
					</pre>
					<li>Atenção: o método <tt>unbind</tt> deve ser chamado no final do método <tt>main</tt> do servidor.</li>	
				</ol>
			</li>
			<br>



			<li>Vamos alterar o <tt>pom.xml</tt> do cliente:</li>
			<ol>
				<li>Adicione a dependência para a bliblioteca <tt>zk-naming</tt>, no mesmo modo que fez para o servidor.</li>
				<li>Adicione ao <tt>pom.xml</tt> do cliente o endereço e porto do ZooKeeper, bem como o <tt>path</tt> do servidor.</li>
				<ol>Este tem que ser igual ao colocado no <tt>pom</tt> do servidor.</ol>
			</ol>
			<br>
			<li>Altere o código do cliente de modo a chamar a biblioteca <tt>zk-naming</tt> para procurar o servidor no ZooKeeper e obter o respectivo <tt>host</tt> e <tt>port</tt>.</li>

			<ol>
				<li>Adicionar as seguintes linhas de código ao cliente:</li>
					<pre class="prettyprint lang-java">
...
ZKNaming zkNaming = new ZKNaming(zooHost,zooPort);
...
// lookup
ZKRecord record = zkNaming.lookup(path);
String target = record.getURI();

final ManagedChannel channel = ManagedChannelBuilder.forTarget(target).usePlaintext().build();
...
// make gRPC calls
...
					</pre>
				<li>Repare que substituímos o argumento do método <tt>forTarget()</tt> pelo par <tt>host:port</tt> obtido através do ZooKeeper.</li>
			</ol>

		<br>
		<li>Execute novamente o cliente e servidor: </li>
		<ol>
			<li>Mantenho o servidor ZooKeeper a correr (inicie se estiver parado)</li>
			<li>Corra <tt>mvn compile exec:java</tt> para o servidor e cliente</li> 
			<li>Observe que o cliente comunica com o servidor, sem ter conhecimento explícito do <tt>host:port</tt> do mesmo</li>
			<li>Pode comprovar, alterando o porto do servidor e testando o cliente sem alterações na sua configuração</li>
		</ol>
		
</ol>

		
        <hr />
        <div class="rodape">
            <p>
                &copy; Docentes de Sistemas Distribuídos,
                <a href="http://www.dei.tecnico.ulisboa.pt/">Dep. Eng. Informática</a>,
                <a href="http://www.ist.eu">Técnico Lisboa</a><br />
            </p>
        </div>
    </body>
</html>