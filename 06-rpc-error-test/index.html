<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <link href="../_css/labs-sd.css" rel="stylesheet" type="text/css"/>
    <link href="../_prettify/prettify.css" rel="stylesheet" type="text/css"/>
    <script src="../_prettify/prettify.js" type="text/javascript"></script>
    <title>Tratamento de erros com gRPC e testes de integração com JUnit</title>

    <style type="text/css">
        body {
            padding-left: 1em;
            padding-right: 1em;
        }

        .underlined {
            text-decoration: underline !important;
        }
    </style>
</head>

<body onload="prettyPrint()">
<div class="contexto">
    <p><a href="../index.html">Labs SD</a> &gt;</p>
</div>
<div class="titulo" id="1">
    <h1>Tratamento de erros com gRPC e testes de integração com JUnit</h1>
</div>
<div class="objectivos">
    <h2>Objetivos da semana</h2>
    <ul>
        <li>Aprender a enviar e receber erros com gRPC</li>
        <li>Aprender a fazer testes de integração utilizando JUnit</li>
        <li>Começar a desenvolver alguns métodos da parte 1 do projeto</li>
    </ul>
</div>
<div class="corpo" style="padding-right: 2em">

<h2 id="conteudos">Materiais de apoio à aula</h2>
<ul>
    <li>
        <a href="grpc-error/index.html">Tratamento de erros com gRPC</a>
    </li>
    <li>
        <a href="junit-it/index.html">Testes de integração com JUnit</a>
    </li>
</ul>

<p class="exemplos">
    Exemplos:
</p>
<ul>
    <li><a href="https://github.com/tecnico-distsys/example_junit" target="_blank">JUnit <img src="../_img/github.png" alt="GitHub" height="16"></a></li>
    <ul>
        <li>Para experimentar o código: fazer <b><i>Clone or Download</b></i> e depois seguir as instruções do <b><tt>README</tt></b></li>
    </ul>
    </li>
    <li><a href="https://github.com/tecnico-distsys/example_error-test-grpc" target="_blank"><i>gRPC example with errors and tests</i> <img src="../_img/github.png" alt="GitHub" height="16"></a></li>
    <ul>
        <li>Para experimentar o código: fazer <b><i>Clone or Download</b></i> e depois seguir as instruções do <b><tt>README</tt></b></li>
    </ul>
    </li>
</ul>


<p>
&nbsp;
</p>
<hr />
        
<h2>Exercício</h2>
<p>
O <b>ponto de partida</b> é o código base que está no repositório <a href="https://github.com/tecnico-distsys/exercise_grpc_error_testing/tree/2022" target="_blank">exercise_grpc_error_testing branch 2022 <img src="../_img/github.png" alt="GitHub" height="16"></a>.
O código deve ser obtido fazendo <b><i>Clone or Download</b></i> e depois seguir as instruções do <b><tt>README</tt></b>
</p>


<h3>Implementação do procedimento remoto <tt>consult user balance</tt>.</h3>
    
<p>
    O objetivo do exercício é extender o comportamente de uma aplicação simples que modela a interação de um cliente com o banco permitindo-lhe consultar o saldo. 
    O procedimento <tt>consult user balance</tt> recebe o nome de um cliente e retorna o saldo do cliente.<br />
    Para este fim, vai-se:
    <ol type="I">
        <li>
            Definir o <tt>consult</tt> no contrato, implementar no servidor e testar manualmente com o cliente;
        </li>
        <li>
            Enviar informação de erro do servidor para o cliente;
        </li>
    </ol>
</p>
<p>
    Vamos então começar!
</p>

<p>
   </li>Comece por executar:

<pre class="prettyprint lang-java">
mvn clean install -DskipTests
</pre>

na diretoria base.
</p>

<ol type="I">
    <li>
        <b>Definir, implementar e experimentar o procedimento remoto <tt>consult</tt> no <tt>contract</tt></b>
        <ol type="1">
            <li>
                Existem três módulos: <tt>contract</tt>, <tt>server</tt> e <tt>client</tt>.
                Vamos começar pelo <b>contrato</b>:
                <ol type="a">
                    <li>
                        Aceder ao ficheiro <tt>.proto</tt>.
                        Este ficheiro define as estruturas de dados e os procedimentos remotos.
                    </li>
                    <li>
                        Cada procedimento necessita de uma mensagem de pedido e de uma mensagem de resposta.
                        <ul>
                            <li>
                                Definir a mensagem do pedido, <tt>ConsultRequest</tt>, que recebe texto simples.
                            </li>
                            <li>
                                Definir a mensagem do resposta, <tt>ConsultResponse</tt>, que devolve um inteiro.
                            </li>
                            <li>
                                Definir o procedimento <tt>rpc</tt> com o nome <tt>consult</tt>, com os tipos de pedido e resposta indicados.
                            </li>
                        </ul>
                    </li>
                    <li>
                        Vamos gerar código Java a partir dos <i>protocol buffers</i>.
                        O Maven está configurado com <i>plug-ins</i> para chamar a ferramenta <tt>protoc</tt> (<i>protocol buffers compiler</i>)
                        <ul>
                            <li>
                                Executar: <tt>mvn install</tt>
                            </li>
                            <li>
                                Se tudo correr bem, as definições protobuf foram convertidas para classes Java, que foram compiladas e instaladas no repositório local do Maven.
                            </li>
                            <li>
                                Para consultar o código gerado, faça <i>refresh</i>
                                (<i>right-click</i>, <i>Maven</i>, <i>Update Project</i>, <i>Force Update of Snapshots/Releases</i>, <i>OK</i>)
                                no Eclipse e depois
                                consulte os ficheiros na pasta:
                                <tt>target/generated-sources/protobuf</tt>.<br />
                                Há classes que representam os tipos de dados das mensagens e há classes de suporte ao servidor e ao cliente do RPC.<br />
                                <br />
                            </li>
                        </ul>
                    </li>
                </ol>
            </li>
            <li>
                Vamos agora concretizar o <b>servidor</b>:
                <ol type="a">
                    <li> 
                        Com base nas classes geradas pelo <tt>protoc</tt> e, por analogia com outros exemplos de servidores gRPC já vistos nas aulas, adicione a  <tt>BankingServiceImpl</tt> e adicione o método de implementação do <tt>consult</tt>:<br />
                                <pre class="prettyprint lang-java">
@Override
public void consult(ConsultRequest request, StreamObserver<ConsultResponse> responseObserver) {
    Integer balance = bank.getBalance(request.getClient());

    ...

    responseObserver.onNext(...);
    responseObserver.onCompleted();
}
                                </pre>
                    </li>
                    <li>
                        Ajuste a classe <tt>Bank</tt>, escrevendo a businness logic que a operação consult implica.
                    </li>
                    <li>
                        Para compilar e testar, fazer: <tt>mvn compile exec:java</tt><br />
                        <br />
                    </li>
                </ol>
            </li>
            <li>
                Vamos agora concretizar o <b>cliente</b>:
                <ol type="a">
                    <li>
                        No objeto <tt>BankingApp</tt> deverá criar um comando que permita realizar o pedido através do stub.
                        <pre class="prettyprint lang-java">
ConsultResponse responseConsult = stub.consult(ConsultRequest.newBuilder().setClient(client).build());

System.out.println(responseConsult.getBalance());

                        </pre>
                    </li>
                    <li>
                        Para compilar e testar:<br />
                        <tt>mvn compile exec:java</tt><br />
                        <br />
                    </li>
                </ol>
            </li>
        </ol>
    </li>
    <li>
        <b>Enviar informação de erro do servidor para o cliente</b>
        <ol type="1">
            <li>
                Vamos adicionar um retorno de erro ao servidor caso a mensagem do pedido seja um cliente não existente.<br />
                Importar a definição de um estado de erro para argumentos inválidos:
                <pre class="prettyprint lang-java">
import static io.grpc.Status.INVALID_ARGUMENT;
...
                </pre>
            </li>
            <li>
                Verificar se o cliente existe e devolver o erro em caso afirmativo.
                <pre class="prettyprint lang-java">
...
if (bank.isClient(client) == false) {
    responseObserver.onError(INVALID_ARGUMENT.withDescription("Input has to be a valid user!").asRuntimeException());
}
...
                </pre>
            </li>
            <li>
                Do lado do cliente, vamos apanhar uma exceção e imprimir a mensagem de erro:
                <pre class="prettyprint lang-java">
try {
    ConsultRequest request = ConsultRequest.newBuilder().setClient(client).build();
    ConsultResponse response = stub.consult(request);

} catch (StatusRuntimeException e) {
    System.out.println("Caught exception with description: " + 
        e.getStatus().getDescription());
}
                </pre>
                <br />
            </li>
        </ol>
    </li>

<p>&nbsp;</p>
</div>
<hr/>
<div class="rodape">
    <p>&copy; Docentes de Sistemas Distribu&iacute;dos, <a href="http://www.dei.tecnico.ulisboa.pt/">Dep. Eng.
        Informática</a>, <a href="http://www.ist.eu">Técnico Lisboa</a>
        <br/>
    </p>
</div>
</body>
</html>
