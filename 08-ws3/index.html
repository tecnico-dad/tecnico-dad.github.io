<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <link rel="stylesheet" type="text/css" href="../_css/labs-sd.css">

    <link href="../_prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../_prettify/prettify.js"></script>

    <title>SOAP Handlers (Web Services III)</title>
</head>

<body onload="prettyPrint()">

<div class="contexto">
    <p>
        <a href="../index.html">Labs SD</a> &gt;
    </p>
</div>

<div class="titulo" id="1">
    <h1>Web Services III: SOAP Handlers</h1>
</div>

<div class="objectivos">

    <h2>Objectivos</h2>
    <ul>
        <li>Construir e modificar mensagens SOAP</li>
        <li>Desenvolver <i>SOAP Handlers</i> para modificar as mensagens XML do Web Service</li>
        <!--li>Passar dados entre os <i>Handlers</i> e as classes de implementa袯 do Web Service</li-->
    </ul>
</div>

<div class="indice">
<p><b>̮dice:</b></p>
<ul>
    <li><a href="#soap">SOAP</a></li>
    <!--ul>
        <li><a href="#saaj">SAAJ</a></li>
        <!--ul>
            <li><a href="#ex-soap-xml">Exemplos</a></li>
        </ul-->
    <!--/ul-->
    <li><a href="#handlers">Handlers</a></li>
    <ul>
        <li><a href="#handlers-config">Configura袯</a></li>
        <li><a href="#bib-handlers">Biblioteca <tt>ws-handlers</tt></a></li>
        <li><a href="#ex-handlers">Exemplo de inspe袯 de mensagens</a></li>
        <!--li><a href="#relay-handlers">Exemplos de estafetas de dados</a></li-->
    </ul>
</ul>
</div>

<div class="corpo">

<hr />

<h2 id="soap">SOAP</h2>
<!--img src="xml.png" height="25" /-->
<img src="envelope.png" height="40" />

<p>
O SOAP 矯 formato de mensagens para Web Services.
Os envelopes podem ser transportados pela rede de diversas formas,
mas a mais comum 矡trav豠do protocolo HTTP.
O SOAP 矩ndependente do protocolo de transporte.
</p>

<p>
Os documentos seguintes s⭠mensagens SOAP
correspondentes a um par pedido-resposta.
<!-- trocado por um cliente com um Web Service. -->
</p>
<pre class="prettyprint">
&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema"
         xmlns:ns1="urn:hello"&gt;
    &lt;soapenv:Body&gt;
        &lt;ns1:sayHello&gt;
            &lt;ns1:name&gt;friend&lt;/ns1:name&gt;
        &lt;/ns1:sayHello&gt;
    &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;<!--/pre>
<p>
<pre class="prettyprint"-->

&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                     xmlns:xsd="http://www.w3.org/2001/XMLSchema"
                     xmlns:ns1="urn:hello"&gt;
    &lt;soapenv:Body&gt;
        &lt;ns1:sayHelloResponse&gt;
            &lt;ns1:return&gt;Hello friend!&lt;/ns1:return&gt;
        &lt;/ns1:sayHelloResponse&gt;
    &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;
</pre>

<p>
Uma mensagem SOAP 矵m documento XML
designado por <i>envelope</i>.
<!--
O SOAP separa o cabe栬ho, com dados de sistema para serem
processados pelas bibliotecas de Web Services, do corpo, com dados de
neg򢨯 para serem processados pelas aplica败s.
</p>
<p-->
O cabe栬ho <i>header</i> permite a composi袯 de protocolos,
pois cada elemento de extens⭠indica a sua vers⭠e
a opcionalidade da sua interpreta袯.<br />
O corpo (<i>body</i>) cont諠os dados de neg򢨯 da mensagem ou
ent⭠o elemento <i>Fault</i> com informa袯 de erro.
</p>
<!--h3 id="saaj">SAAJ</h3-->
<p>
A SAAJ (SOAP with Attachments API for Java) 矵ma
biblioteca que estende o XML DOM, adaptando-o
para documentos XML que s⭠<b>mensagens SOAP</b>.
Isto significa que existem v౩os m賯dos espec쥩cos
para tratar as mensagens.
</p>

<p>
Na biblioteca SAAJ,
uma mensagem SOAP tem a seguinte estrutura:
</p>
<p>
<img src="soap-message.gif" alt="SOAP Message" height="250">
</p>
<p>
A SOAPMessage cont諠v౩as partes.
A primeira parte 矵ma SOAPPart, que cont諠um SOAPEnvelope.<br />
Um SOAPEnvelope cont諠um SOAPBody e opcionalmente um SOAPHeader.<br />
Dentro destes, podem ser colocados SOAPElement.<br />
<!--/p>
<p-->
Numa mensagem SOAP, os elementos devem ser sempre especificados
com espa歠de nomes,
para evitar conflitos.
</p>

<p>
Os objectos da biblioteca SAAJ est⭠no pacote <tt>javax.xml.soap.*</tt><br />
O exemplo seguinte mostra como se constr򧟵ma mensagem simples.
</p>
<p>
<pre class="prettyprint">
    ...

    MessageFactory mf = MessageFactory.newInstance();

    SOAPMessage soapMessage = mf.createMessage();
    SOAPPart soapPart = soapMessage.getSOAPPart();
    SOAPEnvelope soapEnvelope = soapPart.getEnvelope();
    SOAPBody soapBody = soapEnvelope.getBody();
    Name name = soapEnvelope.createName("HelloWorld", "hw", "urn:helloworld");
    SOAPElement element = soapBody.addChildElement(name);
    element.addTextNode( "hello text message" );

    ...

    soapMessage.writeTo(System.out);
    System.out.println();

    ...
</pre>
</p>

<h4 id="ex-soap-xml">Exemplos SOAP e XML</h4>
<p>
Os exemplos seguintes mostram como modificar as mensagens SOAP e
como enviar mensagem SOAP directamente sem <i>stubs</i>.<br />
Para complementar existem tamb諠exemplos das tecnologias base de XML:
SAX, DOM, XSD, XPath.
</p>
<ul>
    <li>
        <a href="soap.zip">SOAP
        <img src="../_img/zip.png" alt="ZIP"></a>
        - SOAP API for JAVA (SAAJ)<br />
    </li>
    <li>
        <a href="xml.zip">XML
        <img src="../_img/zip.png" alt="ZIP"></a>
        - Processamento de XML em JAVA<br />
    </li>
</ul>


<p>&nbsp;</p>

<hr />

<h2 id="handlers">SOAP Handlers</h2>
<!--p>
O JAX-WS 矵ma biblioteca para a plataforma Java que simplifica a invoca袯 de Web Services,
fazendo o mapeamento de tipos para Java para mensagens SOAP.
Normalmente os programadores nem sequer precisam de "ver" as mensagens SOAP.
No entanto, quando se quer implementar seguran柠ao n쵥l das mensagens ou
transportar informa袯 adicional relativa a transac败s distribu죡s,
矮ecess౩o ter uma forma de aceder &agrave;s mensagens SOAP.
</p-->
<p>
A biblioteca de Web Services para Java, JAX-WS,
tem um mecanismo que permite intercetar e
aceder diretamente �mensagens SOAP.<br />
<!--Os JAX-WS Handlers s⭠objectos intercetores que podem ler e
escrever dados nas mensagens SOAP geradas pelos Stubs
e pelos Ties.-->
</p>
<p>
<img src="handler.png" alt="Handlers" height="300">
</p>
<p>

<p>
Um <i>Handler</i> 矵ma classe Java que implementa a
interface <tt>javax.xml.ws.handler.soap.SOAPHandler</tt>.
</p>
<p>
O seguinte exemplo 矵m <i>Handler</i> b಩co.
O principal m賯do
矯 <tt>handleMessage()</tt> que 矩nvocado de cada vez que
chega ou parte uma mensagem:
</p>
<p>
<pre class="prettyprint">
package example.ws.handler;

import java.util.Set;
import javax.xml.namespace.QName;
import javax.xml.ws.handler.MessageContext;
import javax.xml.ws.handler.soap.SOAPHandler;
import javax.xml.ws.handler.soap.SOAPMessageContext;

public class EmptyHandler implements SOAPHandler<SOAPMessageContext> {

    /**
     * Gets the names of the header blocks that can be processed by this Handler instance.
     * If null, processes all.
     */
    public Set<QName> getHeaders() {
        return null;
    }

    /**
     * The handleMessage method is invoked for normal processing of inbound and
     * outbound messages.
     */
     public boolean <b>handleMessage</b>(SOAPMessageContext smc) {
        return true;
    }

    /** The handleFault method is invoked for fault message processing. */
    public boolean handleFault(SOAPMessageContext smc) {
        return true;
    }

    /**
     * Called at the conclusion of a message exchange pattern just prior to the
     * JAX-WS runtime dispatching a message, fault or exception.
     */
    public void close(MessageContext messageContext) {

    }

}
</pre>
</p>

<p>&nbsp;</p>
<h3 id="handlers-context">Configura袯 e parametriza袯</h3>
<p>
Os <i>Handlers</i> s⭠classes Java como quaisquer outras.
No entanto, 
como s⭠constru죡s pelo <i>Web Services Run-time</i> e n⭠pela aplica袯, 
n⭠h�orma direta de lhes aceder.
Por este motivo,
n⭠se consegue "passar" argumentos para os <i>Handlers</i>.
</p>
<p>
Assim sendo,
algumas formas poss쵥is de configurar um <i>Handler</i> s⭠as seguintes:
</p>
<ul>
    <li>
    Receber parᬥtros via contexto (<tt>SOAPMessageContext</tt>)<br />
    - esta t袮ica 矩lustrada no exemplo <a href="#relay-handlers"><tt>handler_relay</tt></a>
    </li>
    <li>
    Receber parᬥtros via vari൥is globais 
    <!--�nst᭣ia da JVM-->
    </li>
    <ul>
        <li>
        Por exemplo, um objeto <tt>Singleton</tt> 
        e.g. <tt>HandlersContext</tt>.
        </li>
        <li>
        Vari൥is <tt>static</tt> nas pr򯱩as classes dos <i>Handlers</i>
        </li>
        <li>
        <i>JVM System properties</i>,
        acess쵥is depois por <tt>System.getProperty()</tt>
        </li>
        <!--li>
        <i>Environment variables</i> (vari൥is de ambiente do sistema operativo),
        acess쵥is depois por <tt>System.getenv();</tt>
        </li-->
    </ul>
</ul>
<p>
As vari൥is s⭠globais �nst᭣ia da Java Virtual Machine (JVM)
que corresponde a um processo no sistema operativo;
por isso, diferentes programas em execu袯 ter⭠diferentes valores nas vari൥is.
</p>
<p>
As vari൥is globais podem ser preenchidas, por exemplo, 
no m賯do <tt>main()</tt> do programa que vai usar os <i>Handlers</i>.
</p>


<h3 id="handlers-ex">Retorno e Exce败s</h3>
<p>
O retorno do m賯do <tt>handleMessage()</tt> determina de que forma
prossegue o processamento da mensagem.<br />
Se for 'true' o processamento deve prosseguir;
se for 'false' bloqueia o processamento da mensagem,
mudando-lhe o sentido e
fazendo-a voltar para o cliente.
</p>
<p>
A utiliza袯 de <b>exce败s</b> permite modificar o normal
processamento das mensagens SOAP:
</p>
<ul>
<li>
Se um <i>handler</i> atirar uma exce袯 <tt>java.lang.RuntimeException</tt>
(ou um sub-tipo desta classe),
indica que o processamento normal da mensagem deve parar.
O m賯do <tt>close()</tt> 矩nvocado nos <i>handlers</i> que entretanto j�inham
sido chamados, o sentido da mensagem 矩nvertido
e a excep袯 矤espachada.
Se a mensagem tinha o sentido de sa죡 (<i>outbound</i>),
矧erada uma mensagem SOAP automaticamente
preenchida com uma SOAP <i>Fault</i>.
</li>
<li>
Se um <i>handler</i> atirar uma exce袯 <tt>javax.xml.ws.soap.SOAPFaultException</tt>
(que 矵m sub-tipo de <tt>javax.xml.ws.ProtocolException</tt>),
indica que o processamento normal da mensagem deve parar
e que se deve iniciar o processamento de mensagem de erro.
O sentido da mensagem 矩nvertido,
se a mensagem n⭠矡inda uma mensagem de Fault
石ubstitu죡 por uma mensagem de Fault,
e o m賯do <tt>handleFault()</tt> 矩nvocado para o pr򷨭o <i>Handler</i> caso exista,
para que seja preenchida manualmente a informa袯 da <i>Fault</i>.
</li>
</ul>

<p>&nbsp;</p>
<h3 id="handlers-config">Configura袯</h2>
<p>
A configura袯 dos <i>Handlers</i>
知fectuada num ficheiro que define a cadeia de <i>handlers</i>.
</p>
<p>
<pre class="prettyprint">
&lt;handler-chains xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;&gt;
    &lt;handler-chain&gt;
        &lt;handler&gt;
            &lt;handler-class&gt;example.ws.handler.LoggingHandler&lt;/handler-class&gt;
        &lt;/handler&gt;
    &lt;/handler-chain&gt;
&lt;/handler-chains&gt;
</pre>
<p>
A configura袯 os <i>Handlers</i> 矤iferente no servidor e no cliente.
Em ambos os casos n⭠s⭠necess౩as altera败s aos <tt>pom.xml</tt>.
<ul>
<li>
No <b>servidor</b>:
    <ul>
    <li>
    Colocar o ficheiro de configura袯 <tt>handler-chain.xml</tt> na pasta
    <tt>src/main/resources</tt>
    </li>
    <li>
    Acrescentar a seguinte anota袯 na classe de implementa袯:
    <tt>@HandlerChain(file="/handler-chain.xml")</tt>
    </li>
    </ul>
</li>
<li>
No <b>cliente</b>:
    <ul>
    <li>
    Colocar o ficheiro de configura袯 <tt>handler-chain-binding.xml</tt> na pasta
    <tt>src/jaxws</tt> (definida por conven袯)
    </li>
    <!--li>
    <small>Nota: a defini袯 do <i>handler</i> pode ter que ficar num fragmento XML �arte
    - <tt>HelloImplService_handler.xml</tt>, no exemplo abaixo -
    devido a problemas de compatibilidade com vers�mais antigas do JAX-WS</small>
    </li-->
    </ul>
</li>
</ul>
</p>


<p>&nbsp;</p>
<h3 id="bib-handlers">Biblioteca <tt>ws-handlers</tt></h3>
<p>
Esta biblioteca 矵m m򣴬o Maven com <i>Handlers</i> que podem ser usados em servidores e clientes.
<!--
sem ter que copiar as mesmas classes por diversos projetos (o que 矵ma m�r೩ca a evitar).
-->
</p>
<ul>
    <li>
        <a href="ws-handlers.zip">Biblioteca de JAX-WS Handlers
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        - cont諺
        <ul>
            <li><tt>LoggingHandler</tt> - imprime mensagens SOAP para <tt>System.out</tt></li>
            <li><tt>MessageContextHandler</tt> - imprime vari൥is de contexto para <tt>System.out</tt></li>
            <li><tt>HeaderHandler</tt> - acrescenta um Header �ensagem SOAP</li>
        </ul>
        <ul>
            <li><tt>HeaderHandlerTest</tt> - usa <i>mocks</i> para testar localmente um handler</li>
        </ul>
        - para usar:
        <ul>
            <li>fazer <tt>mvn install</tt> para compilar e instalar o m򣴬o no reposit򱨯 local do Maven</li>
            <li>acrescentar a depend魣ia para 
            <tt>example:ws-handlers:1.0-SNAPSHOT</tt> 
            no <tt>pom.xml</tt> do projeto que vai usar 
            os <i>Handlers</i></li>
            <li>editar/acrescentar o ficheiro de configura袯 dos 
            <i>handlers</i> no projeto que os vai usar</li>
        </ul>
    </li>
</ul>
<p>
Esta biblioteca poder�er enriquecida com <i>handlers</i> 
adicionais (por exemplo, no projeto).
</p>

<p>&nbsp;</p>
<h3 id="ex-handlers">Exemplo de <i>Handlers</i> de inspe袯 de mensagens</h3>
<img src="looking-glass.png" height="60" />
<p>
Este exemplo demonstra a forma como os SOAP Handlers acedem �mensagens XML dos Web Services.
</p>
<ul>
    <li>
        <a href="hello-ws_handlers.zip">Web Service com JAX-WS Handlers
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        - os SOAP Handlers permitem intercetar as mensagens SOAP que s⭠enviadas e recebidas.<br />
        A configura袯 矦eita atrav豠de um ficheiro e de uma anota袯.
    </li>
    <li>
        <a href="hello-ws-cli_handlers.zip">Web Service client com JAX-WS Handlers
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        - a defini袯 de handlers no cliente 矦eita atrav豠de um ficheiro de configura袯.
    </li>
</ul>

<p>&nbsp;</p>
<h3 id="relay-handlers">Exemplo de <i>Handlers</i> estafetas de dados</h3>
<img src="relay.png" height="75" />
<p>
Este exemplo demonstra os mecanismos de passagem de dados entre as diversas camadas de um Web Service:<br />
<ol>
    <li>
        do cliente para o <i>handler</i> cliente (via contexto do pedido, que 矯btido a partir do <i>stub</i>),
    </li>
    <li>
        do <i>handler</i> cliente para o <i>handler</i> servidor (via cabe栬ho na mensagem SOAP),
    </li>
    <li>
        do <i>handler</i> servidor para o servidor (via contexto das mensagens que 矦ornecido como argumento),
    </li>
    <li>
        do servidor para o <i>handler</i> servidor
        (novamente via contexto das mensagens que 矦ornecido pela biblioteca atrav豠da anota袯 <tt>@Resource</tt>),
    </li>
    <li>
        do <i>handler</i> servidor para o <i>handler</i> cliente (via cabe栬ho na mensagem SOAP),
    </li>
    <li>
        e finalmente,
        do <i>handler</i> cliente para o servidor (via contexto da resposta).
    </li>
</ol>
</p>

<p>
Consultar os exemplos seguindo os coment౩os numerados <tt>#1, #2, #3, ...</tt> que seguem a sequ魣ia de uma
invoca袯 remota come栮do no cliente, passando pelo servidor e voltando ao cliente.
Pelo caminho o <i>token</i> vai sendo acrescentado com mais dados.
<ul>
    <li>
        <a href="hello-ws_handlers_relay.zip">Web Service Relay
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
    </li>
    <li>
        <a href="hello-ws-cli_handlers_relay.zip">Web Service client Relay
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
    </li>
</ul>

</div>

<p>
&nbsp;
</p>
<hr />
<h2>Exerc좩o</h2>
<h3>Terceira parte do projeto</h3>

<p>
O objetivo deste exerc&iacute;cio &eacute; configurar o <i>LoggingHandler</i> para intercetar as comunica败s.
</p>

<p>
Come栲 por <tt>supplier-ws</tt>:
</p>
<ol>
    <li>
    Adicionar a depend魣ia para a biblioteca <tt>ws-handlers</tt> no <tt>pom.xml</tt>.
    </li>
    <li>
    Na pasta <tt>src/main/resources</tt>
    adicionar ficheiro <tt>supplier-ws_handler-chain.xml</tt> com configura袯 da cadeia de interce袯.<br />
    O <i>LoggingHandler</i> deve ser chamado no in좩o e no fim da cadeia.
    </li>
    <li>
    Adicionar a seguinte anota袯 ao <tt>PortImpl</tt>:<br />
<pre class="prettyprint lang-java">
@HandlerChain(file = "/supplier-ws_handler-chain.xml")
</pre>
    </li>
    <li>
    Lan栲 o servidor.
    </li>
    <ul>
        <li><tt>cd supplier-ws</tt></li>
        <li><tt>mvn compile exec:java</tt></li>
    </ul>
    <li>
    Usar o cliente para chamar o <tt>ping</tt>.
    </li>
    <ul>
        <li><tt>cd supplier-ws-cli</tt></li>
        <li><tt>mvn compile exec:java</tt></li>
    </ul>
    <li>
    Agora, ao receber mensagens, estas devem ser capturadas e
    impressas para a consola do servidor.
    </li>
</ol>

<p>
Configurar os <i>handlers</i> <tt>supplier-ws-cli</tt>:
</p>
<ol>
    <li>
    Adicionar tamb諠a depend魣ia para a biblioteca <tt>ws-handlers</tt>.
    </li>
    <li>
    Criar os ficheiros de configura袯
    da cadeia de handlers na pasta <tt>src/jaxws</tt>
    </li>
    <ul>
        <li>
        Para ver ficheiros de configura袯 semelhantes,
        consultar este
        <a href="hello-ws-cli_handlers.zip">exemplo</a>.
        </li>
    </ul>
    <li>
    Para verificar se a configura袯 ficou bem feita,
    fazer uma chamada ao <tt>ping</tt> e
    confirmar que as mensagens s⭠tamb諠capturadas e 
    impressas na consola do lado do cliente.
    </li>
    <!--ul>
        <li>
        N⭠矮ecess౩o parar o servidor, apenas o cliente muda
        </li>
    </ul>
    <li>
    </li-->
</ol>
<p>
Neste ponto as mensagens SOAP est⭠a ser capturadas �a죡 no cliente e �hegada no servidor.
</p>
<p>
Vamos agora criar um novo <i>handler</i> para valida袯 temporal das mensagens:
</p>
<ol>
    <li>
    Criar um <i>handler</i> que acrescenta um cabe栬ho simples �a죡 do cliente 
    (<i>outbound message</i>)
    com a data e hora atual.
    </li>
    <li>
    O novo <i>handler</i> deve ler o cabe栬ho �hegada ao servidor 
    (<i>inbound message</i>).
    </li>
    <li>
    Confirmar que o novo <i>handler</i> funciona como esperado.<br />
    O <i>LoggingHandler</i> deve ser chamado no in좩o e no fim da cadeia para ver 
    a mensagem antes e depois da modifica袯.
    </li>
    <li>
    Modificar o <i>handler</i> para aplicar a seguinte regra:<br />
    Caso a diferen柠temporal seja maior do que 
    3 segundos (valor configur൥l),
    rejeitar a mensagem<br /> 
    (ver sec袯 sobre <a href="#handlers-ex">retorno e exce败s</a> em <i>handlers</i>)
    </li>
    </ul>
    <li>
    De que forma se poder�estar a rejei袯 de mensagem?
    </li>
</ol>

<p>
Pr򷨭os passos</tt>:
</p>
<ul>
    <li>
    Para cada requisito de seguran柠referido no enunciado do projeto:
    </li>
    <ul>
        <li>
        Identificar que altera败s s⭠necess౩as �mensagens SOAP.
        </li>
        <ul>
            <li>
            O que se deve fazer �a죡 da mensagem?
            </li>
            <li>
            O que se deve fazer �hegada?
            </li>
            <ul>
                <li>
                O que fazer quando a mensagem n⭠corresponde ao esperado?
                </li>
            </ul>
        </ul>
        <li>
        Definir <i>handlers</i> (e outros objetos) para implementar
        as altera败s necess౩as
        </li>
        <li>
        Implementar de forma gradual.
        </li>
    </ul>
</ul>

<p>
<b>Bom trabalho!</b>
</p>


<p>
&nbsp;
</p>
<hr />

<div class="rodape">
<p>
&copy; Docentes de Sistemas Distribu죯s,
<a href="http://www.dei.tecnico.ulisboa.pt/">Dep. Eng. Inform೩ca</a>,
<a href="http://www.ist.eu">T袮ico Lisboa</a><br />
</p>
</div>

</body></html>
