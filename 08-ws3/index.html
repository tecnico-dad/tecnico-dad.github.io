<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <link rel="stylesheet" type="text/css" href="../_css/labs-sd.css">

    <link href="../_prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../_prettify/prettify.js"></script>

    <title>SOAP Handlers (Web Services III)</title>
</head>

<body onload="prettyPrint()">

<div class="contexto">
    <p>
        <a href="../index.html">Labs SD</a> &gt;
    </p>
</div>

<div class="titulo" id="1">
    <h1>Web Services III: SOAP Handlers</h1>
</div>

<div class="objectivos">

    <h2>Objectivos</h2>
    <ul>
        <li>Construir e modificar mensagens SOAP</li>
        <li>Desenvolver <i>SOAP Handlers</i> para modificar as mensagens XML do Web Service</li>
        <!--li>Passar dados entre os <i>Handlers</i> e as classes de implementação do Web Service</li-->
    </ul>
</div>

<div class="indice">
<p><b>Índice:</b></p>
<ul>
    <li><a href="#soap">SOAP</a></li>
    <!--ul>
        <li><a href="#saaj">SAAJ</a></li>
        <!--ul>
            <li><a href="#ex-soap-xml">Exemplos</a></li>
        </ul-->
    <!--/ul-->
    <li><a href="#handlers">Handlers</a></li>
    <ul>
        <li><a href="#handlers-config">Configuração</a></li>
        <li><a href="#bib-handlers">Biblioteca <tt>ws-handlers</tt></a></li>
        <li><a href="#ex-handlers">Exemplo de inspeção de mensagens</a></li>
        <!--li><a href="#relay-handlers">Exemplos de estafetas de dados</a></li-->
    </ul>
</ul>
</div>

<div class="corpo">

<hr />

<h2 id="soap">SOAP</h2>
<!--img src="xml.png" height="25" /-->
<img src="envelope.png" height="40" />

<p>
O SOAP é o formato de mensagens para Web Services.
Os envelopes podem ser transportados pela rede de diversas formas,
mas a mais comum é através do protocolo HTTP.
O SOAP é independente do protocolo de transporte.
</p>

<p>
Os documentos seguintes são mensagens SOAP
correspondentes a um par pedido-resposta.
<!-- trocado por um cliente com um Web Service. -->
</p>
<pre class="prettyprint">
&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema"
         xmlns:ns1="urn:hello"&gt;
    &lt;soapenv:Body&gt;
        &lt;ns1:sayHello&gt;
            &lt;ns1:name&gt;friend&lt;/ns1:name&gt;
        &lt;/ns1:sayHello&gt;
    &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;<!--/pre>
<p>
<pre class="prettyprint"-->

&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                     xmlns:xsd="http://www.w3.org/2001/XMLSchema"
                     xmlns:ns1="urn:hello"&gt;
    &lt;soapenv:Body&gt;
        &lt;ns1:sayHelloResponse&gt;
            &lt;ns1:return&gt;Hello friend!&lt;/ns1:return&gt;
        &lt;/ns1:sayHelloResponse&gt;
    &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;
</pre>

<p>
Uma mensagem SOAP é um documento XML
designado por <i>envelope</i>.
<!--
O SOAP separa o cabeçalho, com dados de sistema para serem
processados pelas bibliotecas de Web Services, do corpo, com dados de
negócio para serem processados pelas aplicações.
</p>
<p-->
O cabeçalho <i>header</i> permite a composição de protocolos,
pois cada elemento de extensão indica a sua versão e
a opcionalidade da sua interpretação.<br />
O corpo (<i>body</i>) contém os dados de negócio da mensagem ou
então o elemento <i>Fault</i> com informação de erro.
</p>
<!--h3 id="saaj">SAAJ</h3-->
<p>
A SAAJ (SOAP with Attachments API for Java) é uma
biblioteca que estende o XML DOM, adaptando-o
para documentos XML que são <b>mensagens SOAP</b>.
Isto significa que existem vários métodos específicos
para tratar as mensagens.
</p>

<p>
Na biblioteca SAAJ,
uma mensagem SOAP tem a seguinte estrutura:
</p>
<p>
<img src="soap-message.gif" alt="SOAP Message" height="250">
</p>
<p>
A SOAPMessage contém várias partes.
A primeira parte é uma SOAPPart, que contém um SOAPEnvelope.<br />
Um SOAPEnvelope contém um SOAPBody e opcionalmente um SOAPHeader.<br />
Dentro destes, podem ser colocados SOAPElement.<br />
<!--/p>
<p-->
Numa mensagem SOAP, os elementos devem ser sempre especificados
com espaço de nomes,
para evitar conflitos.
</p>

<p>
Os objectos da biblioteca SAAJ estão no pacote <tt>javax.xml.soap.*</tt><br />
O exemplo seguinte mostra como se constrói uma mensagem simples.
</p>
<p>
<pre class="prettyprint">
    ...

    MessageFactory mf = MessageFactory.newInstance();

    SOAPMessage soapMessage = mf.createMessage();
    SOAPPart soapPart = soapMessage.getSOAPPart();
    SOAPEnvelope soapEnvelope = soapPart.getEnvelope();
    SOAPBody soapBody = soapEnvelope.getBody();
    Name name = soapEnvelope.createName("HelloWorld", "hw", "urn:helloworld");
    SOAPElement element = soapBody.addChildElement(name);
    element.addTextNode( "hello text message" );

    ...

    soapMessage.writeTo(System.out);
    System.out.println();

    ...
</pre>
</p>

<h4 id="ex-soap-xml">Exemplos SOAP e XML</h4>
<p>
Os exemplos seguintes mostram como modificar as mensagens SOAP e
como enviar mensagem SOAP directamente sem <i>stubs</i>.<br />
Para complementar existem também exemplos das tecnologias base de XML:
SAX, DOM, XSD, XPath.
</p>
<ul>
    <li>
        <a href="soap.zip">SOAP
        <img src="../_img/zip.png" alt="ZIP"></a>
        - SOAP API for JAVA (SAAJ)<br />
    </li>
    <li>
        <a href="xml.zip">XML
        <img src="../_img/zip.png" alt="ZIP"></a>
        - Processamento de XML em JAVA<br />
    </li>
</ul>


<p>&nbsp;</p>

<hr />

<h2 id="handlers">SOAP Handlers</h2>
<!--p>
O JAX-WS é uma biblioteca para a plataforma Java que simplifica a invocação de Web Services,
fazendo o mapeamento de tipos para Java para mensagens SOAP.
Normalmente os programadores nem sequer precisam de "ver" as mensagens SOAP.
No entanto, quando se quer implementar segurança ao nível das mensagens ou
transportar informação adicional relativa a transacções distribuídas,
é necessário ter uma forma de aceder &agrave;s mensagens SOAP.
</p-->
<p>
A biblioteca de Web Services para Java, JAX-WS,
tem um mecanismo que permite intercetar e
aceder diretamente às mensagens SOAP.<br />
<!--Os JAX-WS Handlers são objectos intercetores que podem ler e
escrever dados nas mensagens SOAP geradas pelos Stubs
e pelos Ties.-->
</p>
<p>
<img src="handler.png" alt="Handlers" height="300">
</p>
<p>

<p>
Um <i>Handler</i> é uma classe Java que implementa a
interface <tt>javax.xml.ws.handler.soap.SOAPHandler</tt>.
</p>
<p>
O seguinte exemplo é um <i>Handler</i> básico.
O principal método
é o <tt>handleMessage()</tt> que é invocado de cada vez que
chega ou parte uma mensagem:
</p>
<p>
<pre class="prettyprint">
package example.ws.handler;

import java.util.Set;
import javax.xml.namespace.QName;
import javax.xml.ws.handler.MessageContext;
import javax.xml.ws.handler.soap.SOAPHandler;
import javax.xml.ws.handler.soap.SOAPMessageContext;

public class EmptyHandler implements SOAPHandler<SOAPMessageContext> {

    /**
     * Gets the names of the header blocks that can be processed by this Handler instance.
     * If null, processes all.
     */
    public Set<QName> getHeaders() {
        return null;
    }

    /**
     * The handleMessage method is invoked for normal processing of inbound and
     * outbound messages.
     */
     public boolean <b>handleMessage</b>(SOAPMessageContext smc) {
        return true;
    }

    /** The handleFault method is invoked for fault message processing. */
    public boolean handleFault(SOAPMessageContext smc) {
        return true;
    }

    /**
     * Called at the conclusion of a message exchange pattern just prior to the
     * JAX-WS runtime dispatching a message, fault or exception.
     */
    public void close(MessageContext messageContext) {

    }

}
</pre>
</p>

<p>&nbsp;</p>
<h3 id="handlers-context">Configuração e parametrização</h3>
<p>
Os <i>Handlers</i> são classes Java como quaisquer outras.
No entanto, 
como são construídas pelo <i>Web Services Run-time</i> e não pela aplicação, 
não há forma direta de lhes aceder.
Por este motivo,
não se consegue "passar" argumentos para os <i>Handlers</i>.
</p>
<p>
Assim sendo,
algumas formas possíveis de configurar um <i>Handler</i> são as seguintes:
</p>
<ul>
    <li>
    Receber parâmetros via contexto (<tt>SOAPMessageContext</tt>)<br />
    - esta técnica é ilustrada no exemplo <a href="#relay-handlers"><tt>handler_relay</tt></a>
    </li>
    <li>
    Receber parâmetros via variáveis globais 
    <!--à instância da JVM-->
    </li>
    <ul>
        <li>
        Por exemplo, um objeto <tt>Singleton</tt> 
        e.g. <tt>HandlersContext</tt>.
        </li>
        <li>
        Variáveis <tt>static</tt> nas próprias classes dos <i>Handlers</i>
        </li>
        <li>
        <i>JVM System properties</i>,
        acessíveis depois por <tt>System.getProperty()</tt>
        </li>
        <!--li>
        <i>Environment variables</i> (variáveis de ambiente do sistema operativo),
        acessíveis depois por <tt>System.getenv();</tt>
        </li-->
    </ul>
</ul>
<p>
As variáveis são globais à instância da Java Virtual Machine (JVM)
que corresponde a um processo no sistema operativo;
por isso, diferentes programas em execução terão diferentes valores nas variáveis.
</p>
<p>
As variáveis globais podem ser preenchidas, por exemplo, 
no método <tt>main()</tt> do programa que vai usar os <i>Handlers</i>.
</p>


<h3 id="handlers-ex">Retorno e Exceções</h3>
<p>
O retorno do método <tt>handleMessage()</tt> determina de que forma
prossegue o processamento da mensagem.<br />
Se for 'true' o processamento deve prosseguir;
se for 'false' bloqueia o processamento da mensagem,
mudando-lhe o sentido e
fazendo-a voltar para o cliente.
</p>
<p>
A utilização de <b>exceções</b> permite modificar o normal
processamento das mensagens SOAP:
</p>
<ul>
<li>
Se um <i>handler</i> atirar uma exceção <tt>java.lang.RuntimeException</tt>
(ou um sub-tipo desta classe),
indica que o processamento normal da mensagem deve parar.
O método <tt>close()</tt> é invocado nos <i>handlers</i> que entretanto já tinham
sido chamados, o sentido da mensagem é invertido
e a excepção é despachada.
Se a mensagem tinha o sentido de saída (<i>outbound</i>),
é gerada uma mensagem SOAP automaticamente
preenchida com uma SOAP <i>Fault</i>.
</li>
<li>
Se um <i>handler</i> atirar uma exceção <tt>javax.xml.ws.soap.SOAPFaultException</tt>
(que é um sub-tipo de <tt>javax.xml.ws.ProtocolException</tt>),
indica que o processamento normal da mensagem deve parar
e que se deve iniciar o processamento de mensagem de erro.
O sentido da mensagem é invertido,
se a mensagem não é ainda uma mensagem de Fault
é substituída por uma mensagem de Fault,
e o método <tt>handleFault()</tt> é invocado para o próximo <i>Handler</i> caso exista,
para que seja preenchida manualmente a informação da <i>Fault</i>.
</li>
</ul>

<p>&nbsp;</p>
<h3 id="handlers-config">Configuração</h2>
<p>
A configuração dos <i>Handlers</i>
é efectuada num ficheiro que define a cadeia de <i>handlers</i>.
</p>
<p>
<pre class="prettyprint">
&lt;handler-chains xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;&gt;
    &lt;handler-chain&gt;
        &lt;handler&gt;
            &lt;handler-class&gt;example.ws.handler.LoggingHandler&lt;/handler-class&gt;
        &lt;/handler&gt;
    &lt;/handler-chain&gt;
&lt;/handler-chains&gt;
</pre>
<p>
A configuração os <i>Handlers</i> é diferente no servidor e no cliente.
Em ambos os casos não são necessárias alterações aos <tt>pom.xml</tt>.
<ul>
<li>
No <b>servidor</b>:
    <ul>
    <li>
    Colocar o ficheiro de configuração <tt>handler-chain.xml</tt> na pasta
    <tt>src/main/resources</tt>
    </li>
    <li>
    Acrescentar a seguinte anotação na classe de implementação:
    <tt>@HandlerChain(file="/handler-chain.xml")</tt>
    </li>
    </ul>
</li>
<li>
No <b>cliente</b>:
    <ul>
    <li>
    Colocar o ficheiro de configuração <tt>handler-chain-binding.xml</tt> na pasta
    <tt>src/jaxws</tt> (definida por convenção)
    </li>
    <!--li>
    <small>Nota: a definição do <i>handler</i> pode ter que ficar num fragmento XML à parte
    - <tt>HelloImplService_handler.xml</tt>, no exemplo abaixo -
    devido a problemas de compatibilidade com versões mais antigas do JAX-WS</small>
    </li-->
    </ul>
</li>
</ul>
</p>


<p>&nbsp;</p>
<h3 id="bib-handlers">Biblioteca <tt>ws-handlers</tt></h3>
<p>
Esta biblioteca é um módulo Maven com <i>Handlers</i> que podem ser usados em servidores e clientes.
<!--
sem ter que copiar as mesmas classes por diversos projetos (o que é uma má prática a evitar).
-->
</p>
<ul>
    <li>
        <a href="ws-handlers.zip">Biblioteca de JAX-WS Handlers
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        - contém:
        <ul>
            <li><tt>LoggingHandler</tt> - imprime mensagens SOAP para <tt>System.out</tt></li>
            <li><tt>MessageContextHandler</tt> - imprime variáveis de contexto para <tt>System.out</tt></li>
            <li><tt>HeaderHandler</tt> - acrescenta um Header à mensagem SOAP</li>
        </ul>
        <ul>
            <li><tt>HeaderHandlerTest</tt> - usa <i>mocks</i> para testar localmente um handler</li>
        </ul>
        - para usar:
        <ul>
            <li>fazer <tt>mvn install</tt> para compilar e instalar o módulo no repositório local do Maven</li>
            <li>acrescentar a dependência para 
            <tt>example:ws-handlers:1.0-SNAPSHOT</tt> 
            no <tt>pom.xml</tt> do projeto que vai usar 
            os <i>Handlers</i></li>
            <li>editar/acrescentar o ficheiro de configuração dos 
            <i>handlers</i> no projeto que os vai usar</li>
        </ul>
    </li>
</ul>
<p>
Esta biblioteca poderá ser enriquecida com <i>handlers</i> 
adicionais (por exemplo, no projeto).
</p>

<p>&nbsp;</p>
<h3 id="ex-handlers">Exemplo de <i>Handlers</i> de inspeção de mensagens</h3>
<img src="looking-glass.png" height="60" />
<p>
Este exemplo demonstra a forma como os SOAP Handlers acedem às mensagens XML dos Web Services.
</p>
<ul>
    <li>
        <a href="hello-ws_handlers.zip">Web Service com JAX-WS Handlers
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        - os SOAP Handlers permitem intercetar as mensagens SOAP que são enviadas e recebidas.<br />
        A configuração é feita através de um ficheiro e de uma anotação.
    </li>
    <li>
        <a href="hello-ws-cli_handlers.zip">Web Service client com JAX-WS Handlers
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        - a definição de handlers no cliente é feita através de um ficheiro de configuração.
    </li>
</ul>

<p>&nbsp;</p>
<h3 id="relay-handlers">Exemplo de <i>Handlers</i> estafetas de dados</h3>
<img src="relay.png" height="75" />
<p>
Este exemplo demonstra os mecanismos de passagem de dados entre as diversas camadas de um Web Service:<br />
<ol>
    <li>
        do cliente para o <i>handler</i> cliente (via contexto do pedido, que é obtido a partir do <i>stub</i>),
    </li>
    <li>
        do <i>handler</i> cliente para o <i>handler</i> servidor (via cabeçalho na mensagem SOAP),
    </li>
    <li>
        do <i>handler</i> servidor para o servidor (via contexto das mensagens que é fornecido como argumento),
    </li>
    <li>
        do servidor para o <i>handler</i> servidor
        (novamente via contexto das mensagens que é fornecido pela biblioteca através da anotação <tt>@Resource</tt>),
    </li>
    <li>
        do <i>handler</i> servidor para o <i>handler</i> cliente (via cabeçalho na mensagem SOAP),
    </li>
    <li>
        e finalmente,
        do <i>handler</i> cliente para o servidor (via contexto da resposta).
    </li>
</ol>
</p>

<p>
Consultar os exemplos seguindo os comentários numerados <tt>#1, #2, #3, ...</tt> que seguem a sequência de uma
invocação remota começando no cliente, passando pelo servidor e voltando ao cliente.
Pelo caminho o <i>token</i> vai sendo acrescentado com mais dados.
<ul>
    <li>
        <a href="hello-ws_handlers_relay.zip">Web Service Relay
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
    </li>
    <li>
        <a href="hello-ws-cli_handlers_relay.zip">Web Service client Relay
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
    </li>
</ul>

</div>

<p>
&nbsp;
</p>
<hr />
<h2>Exercício</h2>
<h3>Terceira parte do projeto</h3>

<p>
O objetivo deste exerc&iacute;cio &eacute; configurar o <i>LoggingHandler</i> para intercetar as comunicações.
</p>

<p>
Começar por <tt>supplier-ws</tt>:
</p>
<ol>
    <li>
    Adicionar a dependência para a biblioteca <tt>ws-handlers</tt> no <tt>pom.xml</tt>.
    </li>
    <li>
    Na pasta <tt>src/main/resources</tt>
    adicionar ficheiro <tt>supplier-ws_handler-chain.xml</tt> com configuração da cadeia de interceção.<br />
    O <i>LoggingHandler</i> deve ser chamado no início e no fim da cadeia.
    </li>
    <li>
    Adicionar a seguinte anotação ao <tt>PortImpl</tt>:<br />
<pre class="prettyprint lang-java">
@HandlerChain(file = "/supplier-ws_handler-chain.xml")
</pre>
    </li>
    <li>
    Lançar o servidor.
    </li>
    <ul>
        <li><tt>cd supplier-ws</tt></li>
        <li><tt>mvn compile exec:java</tt></li>
    </ul>
    <li>
    Usar o cliente para chamar o <tt>ping</tt>.
    </li>
    <ul>
        <li><tt>cd supplier-ws-cli</tt></li>
        <li><tt>mvn compile exec:java</tt></li>
    </ul>
    <li>
    Agora, ao receber mensagens, estas devem ser capturadas e
    impressas para a consola do servidor.
    </li>
</ol>

<p>
Configurar os <i>handlers</i> <tt>supplier-ws-cli</tt>:
</p>
<ol>
    <li>
    Adicionar também a dependência para a biblioteca <tt>ws-handlers</tt>.
    </li>
    <li>
    Criar os ficheiros de configuração
    da cadeia de handlers na pasta <tt>src/jaxws</tt>
    </li>
    <ul>
        <li>
        Para ver ficheiros de configuração semelhantes,
        consultar este
        <a href="hello-ws-cli_handlers.zip">exemplo</a>.
        </li>
    </ul>
    <li>
    Para verificar se a configuração ficou bem feita,
    fazer uma chamada ao <tt>ping</tt> e
    confirmar que as mensagens são também capturadas e 
    impressas na consola do lado do cliente.
    </li>
    <!--ul>
        <li>
        Não é necessário parar o servidor, apenas o cliente muda
        </li>
    </ul>
    <li>
    </li-->
</ol>
<p>
Neste ponto as mensagens SOAP estão a ser capturadas à saída no cliente e à chegada no servidor.
</p>
<p>
Vamos agora criar um novo <i>handler</i> para validação temporal das mensagens:
</p>
<ol>
    <li>
    Criar um <i>handler</i> que acrescenta um cabeçalho simples à saída do cliente 
    (<i>outbound message</i>)
    com a data e hora atual.
    </li>
    <li>
    O novo <i>handler</i> deve ler o cabeçalho à chegada ao servidor 
    (<i>inbound message</i>).
    </li>
    <li>
    Confirmar que o novo <i>handler</i> funciona como esperado.<br />
    O <i>LoggingHandler</i> deve ser chamado no início e no fim da cadeia para ver 
    a mensagem antes e depois da modificação.
    </li>
    <li>
    Modificar o <i>handler</i> para aplicar a seguinte regra:<br />
    Caso a diferença temporal seja maior do que 
    3 segundos (valor configurável),
    rejeitar a mensagem<br /> 
    (ver secção sobre <a href="#handlers-ex">retorno e exceções</a> em <i>handlers</i>)
    </li>
    </ul>
    <li>
    De que forma se poderá testar a rejeição de mensagem?
    </li>
</ol>

<p>
Próximos passos</tt>:
</p>
<ul>
    <li>
    Para cada requisito de segurança referido no enunciado do projeto:
    </li>
    <ul>
        <li>
        Identificar que alterações são necessárias às mensagens SOAP.
        </li>
        <ul>
            <li>
            O que se deve fazer à saída da mensagem?
            </li>
            <li>
            O que se deve fazer à chegada?
            </li>
            <ul>
                <li>
                O que fazer quando a mensagem não corresponde ao esperado?
                </li>
            </ul>
        </ul>
        <li>
        Definir <i>handlers</i> (e outros objetos) para implementar
        as alterações necessárias
        </li>
        <li>
        Implementar de forma gradual.
        </li>
    </ul>
</ul>

<p>
<b>Bom trabalho!</b>
</p>


<p>
&nbsp;
</p>
<hr />

<div class="rodape">
<p>
&copy; Docentes de Sistemas Distribuídos,
<a href="http://www.dei.tecnico.ulisboa.pt/">Dep. Eng. Informática</a>,
<a href="http://www.ist.eu">Técnico Lisboa</a><br />
</p>
</div>

</body></html>
