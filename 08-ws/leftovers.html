<p>
&nbsp;
</p>
<hr />
<h1>Exercício</h1>
<h2>Segunda parte do projeto</h2>

<span style="color:red;font-size:120%">[atualizado]</span>

<p>
Na segunda parte do projeto os saldos dos utilizadores serão replicados, de acordo com um protocolo de <i>quorum consensus</i>, sendo os servidores de estação os gestores de réplicas, e o servidor Binas o cliente deste sistema replicado. 
Desta forma, as estações devem implementar duas novas operações: <tt>getBalance</tt> e <tt>setBalance</tt>.
</p>
<p>
Este exercício tem como objetivo guiar cada grupo nos primeiros passos para resolver a segunda parte do projeto. 
Mais precisamente, sugerimos que comecem por implementar as duas novas operações oferecidas por cada gestor de réplica; 
e modificar o Binas para invocar essas operações <!--de forma assíncrona--> quando pretende aceder ao saldo de um utilizador. 
<!--Para alcançar o objetivo, propõe-se uma abordagem em 2 passos: implementar primeiro com chamadas síncronas e depois modificar para chamadas assíncronas.-->
</p>

<h3>Station</h3>
<p>
Para introduzir as novas operações <tt>getBalance</tt> e <tt>setBalance</tt> é necessário estender o contrato WSDL do servidor de estação.
</p>
<p>
Mais precisamente:
<ul>
	<li>
		A operação <tt>getBalance</tt> deve receber o identificador da conta (email do utilizador) a consultar; 
		deve retornar o valor e a <i>tag</i> que a réplica mantém para essa conta.
	</li>
	<li>
		A operação <tt>setBalance</tt> deve receber o identificador da conta (email do utilizador) a consultar, o novo valor e a <i>tag</i> associada ao novo valor.
	</li>
</ul>
</p>
<p>
Compete a cada grupo prever as exceções que fazem sentido para cada operação.
</p>

<p>Passos recomendados:</p>
<ol>
    <li>Atualizar o WSDL da estação</li>
    <ul>
        <li>Relembrar a estrutura dos contratos WSDL descrita <a href="../05-ws/wsdl/index.html">nesta página</a> de um laboratório anterior.</li>
        <li>Consultar o <a href="../proj/station.1_0.wsdl">WSDL da estação</a>.</li>
        <li>Adicionar as novas operações, mensagens e tipos ao WSDL.</li>

        <li>Colocar o WSDL atualizado, com novo nome <tt>station.2_0.wsdl</tt>, na pasta <tt>src/main/resources</tt> do <tt>station-ws</tt>.</li>
        <li>Atualizar a implementação do serviço para estar de acordo com o novo contrato WSDL.</li>
    </ul>

    <li>Gerar os <i>stubs</i> atualizados</li>
    <ul>
        <li>Executar <tt>mvn clean generate-sources</tt> no <tt>station-ws</tt> e no <tt>station-ws-cli</tt>.</li>
        <li>Adicionar implementação vazia das novas operações da interface na classe <tt>StationPortImpl</tt> do <tt>station-ws</tt> e na classe <tt>StationClient</tt> do <tt>station-ws-cli</tt>.</li>
    </ul>

    <li>Implementar as operações <tt>getBalance</tt> e <tt>setBalance</tt></li>
    <ul>
        <li>Como descrito no enunciado, a estação deve conter um conjunto de contas de utilizador, inicialmente vazio. 
		A cada conta deve estar associada uma <i>tag</i> que denota a versão que a réplica conhece do valor do saldo dessa conta.</li>
        <!--li>A operação <tt>setBalance</tt> deve procurar a conta indicada como argumento e, caso exista, atualizar os respetivos valor e <i>tag</i> caso a <i>tag</i> recebida seja superior à <i>tag</i> mantida na réplica. 
		Caso esta conta não exista na réplica, a operação deve criar uma nova conta na réplica local, inicializada com o valor e <i>tag</i> recebidos.</li>
        <li>A operação <tt>getBalance</tt> deve procurar a conta indicada como argumento e, caso a encontre, devolver os respetivos valor e <i>tag</i> que a réplica mantém para esta conta. 
		Caso contrário, deve devolver uma exceção definida para o efeito.
		</li-->
    </ul>
</ol>

<h3>Binas</h3>
<ol>
    <li>Instalar o <tt>station-ws-cli</tt> atualizado</li>
    <ul>
        <li><tt>cd station-ws-cli</tt></li>
        <li><tt>mvn clean install</tt></li>
    </ul>
    <li>Começar por modificar a operação <tt>activateUser</tt> do serviço Binas para passar a usar o sistema replicado.
    </li>
    <ul>
        <li>A operação <tt>activateUser</tt> do Binas deve chamar a operação <tt>getBalance</tt> da conta a ativar, como forma de verificar se a conta já existe.</li><!-- (nesse caso, deverá lançar exceção).-->
        <li>Caso a conta não exista, a operação <tt>activateUser</tt> deverá chamar a operação <tt>setBalance</tt> para criar e inicializar a nova conta nas réplicas do sistema.</li>
    </ul>
</ol>

<p>
Para começar, por simplificação, sugere-se que se comece por concretizar as invocações das operações <tt>getBalance</tt> e <tt>setBalance</tt> com chamadas síncronas; o Binas deve aguardar pelas respostas de todas as estações, ou seja, de acordo com a figura seguinte: 
</p>

<img src="replicacao-P2-sincrona.png" width="500"/>



<h3>Próximos Passos</h3>
<ul>
    <li>Escrever uma primeira versão do <b>relatório</b> (secção 4.7 do <a href="../proj/enunciado-proj-SD-1718.pdf#page=9">enunciado</a>)</li>
    <ul>
        <li>Discutir esta proposta com o professor assim que possível</li>
    </ul>
</ul>
<ul>
    <li>Substituir as chamadas síncronas por <i>invocação assíncrona</i>, em linha com o previsto no protocolo de <i>quorum consensus</i>. 
	Isto permitirá desacoplar pedidos e respostas tal como no diagrama seguinte.<br /> 
	<img src="replicacao-P2-assincrona.png" width="500"/></li>
    <li>Corrigir a implementação acima para apenas esperar por um quórum de respostas.</li>
    <li>Modificar as restantes operações afetadas no Binas (<tt>getCredit</tt>, <tt>rentBina</tt>, <tt>returnBina</tt>)</li>
    <li>Implementar outras optimizações/simplificações, mantendo a garantia de consistência sequencial</li>
    <li>Verificar o <a href="../01-tools/exceptions/index.html">tratamento correto de exceções</a> e o <a href="../01-tools/java-synch/index.html">acesso sincronizado a dados partilhados</a></li>
</ul>
<ul>
    <li>Preparar o <b>guião de demonstração</b> (secção 4.8 do <a href="../proj/enunciado-proj-SD-1718.pdf#page=9">enunciado</a>)</li>
    <ul>
        <li>Caso F1: funcionamento normal da replicacão</li>
        <li>Caso F2: tolerância a falta</li>
    </ul>
</ul>

<p>
&nbsp;
</p>

<p>
<b>Bom trabalho!</b>
</p>
