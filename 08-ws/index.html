<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <link rel="stylesheet" type="text/css" href="../_css/labs-sd.css">

    <link href="../_prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../_prettify/prettify.js"></script>

    <title>Web Services III</title>
</head>

<body onload="prettyPrint()">

<div class="contexto">
    <p>
        <a href="../index.html">Labs SD</a> &gt;
    </p>
</div>

<div class="titulo" id="1">
    <h1>Web Services III</h1>
</div>

<div class="objectivos">

    <h2>Objectivos</h2>
    <ul>
        <li>Configurar o limite de tempo de espera do cliente</li>
        <li>Invocar uma operação unidireccional <i>(one-way)</i></li>
        <li>Fazer chamadas assíncronas <i>(async)</i></li>
    </ul>
</div>

<div class="indice">
<p><b>Índice:</b></p>
<ul>
    <li><a href="#timeout">Limite de tempo</a></li>
    <li><a href="#oneway">Operações unidireccionais</a></li>
    <li><a href="#async">Operações assíncronas</a></li>
</ul>
</div>

<div class="corpo">

<hr />

<h2 id="timeout">Limite de tempo</h2>
<img src="clock.png" height="60" />
<p>
O exemplo abaixo demonstra como configurar os tempos de espera pelas respostas de Web Services.
No fim do tempo,
caso a resposta não tenha sido recebida,
é lançada uma exceção.
</p>
<p>
O JAX-WS distingue dois <i>timeouts</i> distintos:
<ul>
<li>
<i>connection</i> - quando tempo deve esperar até se estabelecer uma ligação com o servidor;
</li>
<li>
<i>receive</i> - quando tempo deve esperar até receber a resposta a um pedido feito ao servidor.
</li>
</ul>
</p>

<p>
Exemplo:
</p>
<ul>
    <li>
        <a href="hello-ws-cli_timeout.zip">Cliente de Web Service com timeouts
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
    </li>
    <li>
		Para verificar o comportamento do timeout do cliente,
		pode experimentar
		<a href="hello-ws_sleep.zip">este servidor</a>
		que introduz um atraso artificial na execução das suas operações.
    </li>
</ul>

<p>&nbsp;</p>

<hr />

<h2 id="oneway">Operações unidireccionais</h2>
<img src="oneway.png" height="45" />
<p>

As operações unidireccionais de Web Service são aquelas que não enviam resposta, logo o programa cliente é desbloqueado mal a mensagem de pedido saia através da rede. Este exemplo demonstra como definir operações unidireccionais.
</p>

<ul>
    <li>
        <a href="bye-ws_oneway_sleep.zip">Web Service Implementation-first com operação one-way
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        Lançar o servidor,
        abrir o WSDL gerado e confirmar o que é diferente na operação one-way.
        No caso <i>contract-first</i>,
        deverão escrever um WSDL semelhante ao que é gerado neste exemplo.
        A operação <i>one-way</i> não declara <tt>output</tt>
        no <tt>portType</tt> e no <tt>binding</tt>.
    </li>

    <li>
        <a href="bye-ws-cli_oneway.zip">Cliente de Web Service com operação one-way
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        - o cliente é idêntico ao habitual,
        mas podem confirmar que não espera pela conclusão da execução da operação <i>one-way</i> no servidor
    </li>

</ul>

<p>&nbsp;</p>

<hr />

<h2 id="async">Operações assíncronas</h2>

<img src="async.gif" height="120" />
<!-- image credits: http://java.boot.by/scdjws5-guide/ch12s03.html -->

<p>
Em situações em que o cliente não pretenda ficar bloqueado à espera da resposta do servidor (podendo-a receber posteriormente, quando o cliente assim o desejar), é possível fazê-lo através de uma invocação assíncrona.
</p>

<p>
Uma possível forma de fazer invocações assíncronas é através dos métodos com sufixo <tt>Async</tt>.
Para que estes métodos sejam gerados é necessário do lado do cliente indicar um ficheiro de <i>binding</i>, na pasta src/jaxws.
Os <i>stubs</i> assim gerados passam a incluir tanto os métodos para invocação sincrona como assíncrona.
</p>

<pre class="prettyprint lang-xml">
&lt;bindings
    xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;
    xmlns:wsdl=&quot;http://schemas.xmlsoap.org/wsdl/&quot;
    xmlns=&quot;http://java.sun.com/xml/ns/jaxws&quot; &gt;
     &lt;bindings node=&quot;wsdl:definitions&quot;&gt;
         &lt;enableAsyncMapping&gt;true&lt;/enableAsyncMapping&gt;
     &lt;/bindings&gt;
&lt;/bindings&gt;
</pre>

<p>Existem 2 formas alternativas de programar um cliente que recorre a chamadas assíncronas. De seguida explicamos cada uma.</p>

<h3>Invocação com <i>polling</i></h3>
<p>
Para uma invocação assíncrona,
o cliente deve executar um método com o sufixo <tt>Async</tt> e
de seguida usar o método <tt>Response.isDone()</tt> para verificar se a resposta já chegou.
Nesta solução o cliente invoca o método remoto sem ficar bloqueado,
ficando responsável por verificar, periódicamente, se o servidor já respondeu (através do objecto <tt>Response</tt>).
Só depois da resposta ter chegado,
pode então o cliente obter o seu resultado através do objecto <tt>Response</tt>.
</p>

<pre class="prettyprint lang-java">
    // asynchronous call with polling (too slow to wait for it)
    Response<EchoResponse> response = port.echoAsync(name);

    while (!response.isDone()) {
        Thread.sleep(100 /* milliseconds */);

        /* while waiting for response do other calls... */
        String result = port.fastEcho(name);
        System.out.print("Synchronous call result: ");
        System.out.println(result);
    }

    System.out.println("Async->" + response.get().getReturn());
</pre>

<h3>Invocação com <i>callback</i></h3>
<p>
Um outro modelo de funcionamento é o registo de um objecto de <i>callback</i>
do tipo <tt>AsyncHandler</tt> aquando da execução da chamada assíncrona.
Quando a resposta chega,
um método desse objecto é invocado. Este funcionamento é semelhante ao atendimento de interrupções num processador. A rotina de <i>callback</i> corresponde à rotina de atendimento da interrupção. O receber uma resposta do servidor corresponde à interrupção.
</p>

<pre class="prettyprint lang-java">
    static boolean finished = false;

...

    // asynchronous call with callback
    port.echoAsync(name, new AsyncHandler<EchoResponse>() {
        @Override
        public void handleResponse(Response<EchoResponse> response) {
            try {
                System.out.println();
                System.out.print("Asynchronous call result arrived: ");
                System.out.println(response.get().getReturn());
                finished = true;
            } catch (InterruptedException e) {
                System.out.println("Caught interrupted exception.");
                System.out.print("Cause: ");
                System.out.println(e.getCause());
            } catch (ExecutionException e) {
                System.out.println("Caught execution exception.");
                System.out.print("Cause: ");
                System.out.println(e.getCause());
            }
        }
    });
		
    while (!finished) {
    	Thread.sleep(100);
    	System.out.print("."); // do something usefull while waiting...
    	System.out.flush();
    }
</pre>
<br/>
<p>
Em ambos os casos,
a resposta é obtida invocando o método <tt>response.get()</tt> que lança uma exceção caso esta tenha sido retornada pelo método remoto.
Caso o método remoto retorne <tt>Void</tt>,
este método lancará uma <tt>NullPointerException</tt>.
Caso contrário,
o objecto retornado pode ser obtido com o método <tt>getReturn()</tt>.
</p>

<p>Consultar o exemplo de Cliente-Servidor com invocações assíncronas:</p>
<ul>
    <li>
        <a href="echo-ws_async.zip">Web Service com invocações assíncronas
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        - Lançar o servidor da forma habitual
    </li>

    <li>
        <a href="echo-ws-cli_async.zip">Cliente de Web Service com invocações assíncronas
        <img src="../_img/zip.png" alt="ZIP" ></a><br />
        - O cliente é diferente do habitual,
        porque não fica bloqueado à espera da resposta do servidor.
    </li>

</ul>
<p>
Repare que não é preciso alterar o servidor para que o cliente possa fazer invocações assíncronas.
</p>

<p>
&nbsp;
</p>
<hr />
<h1>Exercício</h1>
<h2>Segunda parte do projeto</h2>

<span style="color:red;font-size:120%">[atualizado]</span>

<p>
Na segunda parte do projeto os saldos dos utilizadores serão replicados, de acordo com um protocolo de <i>quorum consensus</i>, sendo os servidores de estação os gestores de réplicas, e o servidor Binas o cliente deste sistema replicado. 
Desta forma, as estações devem implementar duas novas operações: <tt>getBalance</tt> e <tt>setBalance</tt>.
</p>
<p>
Este exercício tem como objetivo guiar cada grupo nos primeiros passos para resolver a segunda parte do projeto. 
Mais precisamente, sugerimos que comecem por implementar as duas novas operações oferecidas por cada gestor de réplica; 
e modificar o Binas para invocar essas operações <!--de forma assíncrona--> quando pretende aceder ao saldo de um utilizador. 
<!--Para alcançar o objetivo, propõe-se uma abordagem em 2 passos: implementar primeiro com chamadas síncronas e depois modificar para chamadas assíncronas.-->
</p>

<h3>Station</h3>
<p>
Para introduzir as novas operações <tt>getBalance</tt> e <tt>setBalance</tt> é necessário estender o contrato WSDL do servidor de estação.
</p>
<p>
Mais precisamente:
<ul>
	<li>
		A operação <tt>getBalance</tt> deve receber o identificador da conta (email do utilizador) a consultar; 
		deve retornar o valor e a <i>tag</i> que a réplica mantém para essa conta.
	</li>
	<li>
		A operação <tt>setBalance</tt> deve receber o identificador da conta (email do utilizador) a consultar, o novo valor e a <i>tag</i> associada ao novo valor.
	</li>
</ul>
</p>
<p>
Compete a cada grupo prever as exceções que fazem sentido para cada operação.
</p>

<p>Passos recomendados:</p>
<ol>
    <li>Atualizar o WSDL da estação</li>
    <ul>
        <li>Relembrar a estrutura dos contratos WSDL descrita <a href="../05-ws/wsdl/index.html">nesta página</a> de um laboratório anterior.</li>
        <li>Consultar o <a href="../proj/station.1_0.wsdl">WSDL da estação</a>.</li>
        <li>Adicionar as novas operações, mensagens e tipos ao WSDL.</li>

        <li>Colocar o WSDL atualizado, com novo nome <tt>station.2_0.wsdl</tt>, na pasta <tt>src/main/resources</tt> do <tt>station-ws</tt>.</li>
        <li>Atualizar a implementação do serviço para estar de acordo com o novo contrato WSDL.</li>
    </ul>

    <li>Gerar os <i>stubs</i> atualizados</li>
    <ul>
        <li>Executar <tt>mvn clean generate-sources</tt> no <tt>station-ws</tt> e no <tt>station-ws-cli</tt>.</li>
        <li>Adicionar implementação vazia das novas operações da interface na classe <tt>StationPortImpl</tt> do <tt>station-ws</tt> e na classe <tt>StationClient</tt> do <tt>station-ws-cli</tt>.</li>
    </ul>

    <li>Implementar as operações <tt>getBalance</tt> e <tt>setBalance</tt></li>
    <ul>
        <li>Como descrito no enunciado, a estação deve conter um conjunto de contas de utilizador, inicialmente vazio. 
		A cada conta deve estar associada uma <i>tag</i> que denota a versão que a réplica conhece do valor do saldo dessa conta.</li>
        <!--li>A operação <tt>setBalance</tt> deve procurar a conta indicada como argumento e, caso exista, atualizar os respetivos valor e <i>tag</i> caso a <i>tag</i> recebida seja superior à <i>tag</i> mantida na réplica. 
		Caso esta conta não exista na réplica, a operação deve criar uma nova conta na réplica local, inicializada com o valor e <i>tag</i> recebidos.</li>
        <li>A operação <tt>getBalance</tt> deve procurar a conta indicada como argumento e, caso a encontre, devolver os respetivos valor e <i>tag</i> que a réplica mantém para esta conta. 
		Caso contrário, deve devolver uma exceção definida para o efeito.
		</li-->
    </ul>
</ol>

<h3>Binas</h3>
<ol>
    <li>Instalar o <tt>station-ws-cli</tt> atualizado</li>
    <ul>
        <li><tt>cd station-ws-cli</tt></li>
        <li><tt>mvn clean install</tt></li>
    </ul>
    <li>Começar por modificar a operação <tt>activateUser</tt> do serviço Binas para passar a usar o sistema replicado.
    </li>
    <ul>
        <li>A operação <tt>activateUser</tt> do Binas deve chamar a operação <tt>getBalance</tt> da conta a ativar, como forma de verificar se a conta já existe.</li><!-- (nesse caso, deverá lançar exceção).-->
        <li>Caso a conta não exista, a operação <tt>activateUser</tt> deverá chamar a operação <tt>setBalance</tt> para criar e inicializar a nova conta nas réplicas do sistema.</li>
    </ul>
</ol>

<p>
Para começar, por simplificação, sugere-se que se comece por concretizar as invocações das operações <tt>getBalance</tt> e <tt>setBalance</tt> com chamadas síncronas; o Binas deve aguardar pelas respostas de todas as estações, ou seja, de acordo com a figura seguinte: 
</p>

<img src="replicacao-P2-sincrona.png" width="500"/>



<h3>Próximos Passos</h3>
<ul>
    <li>Escrever uma primeira versão do <b>relatório</b> (secção 4.7 do <a href="../proj/enunciado-proj-SD-1718.pdf#page=9">enunciado</a>)</li>
    <ul>
        <li>Discutir esta proposta com o professor assim que possível</li>
    </ul>
</ul>
<ul>
    <li>Substituir as chamadas síncronas por <i>invocação assíncrona</i>, em linha com o previsto no protocolo de <i>quorum consensus</i>. 
	Isto permitirá desacoplar pedidos e respostas tal como no diagrama seguinte.<br /> 
	<img src="replicacao-P2-assincrona.png" width="500"/></li>
    <li>Corrigir a implementação acima para apenas esperar por um quórum de respostas.</li>
    <li>Modificar as restantes operações afetadas no Binas (<tt>getCredit</tt>, <tt>rentBina</tt>, <tt>returnBina</tt>)</li>
    <li>Implementar outras optimizações/simplificações, mantendo a garantia de consistência sequencial</li>
    <li>Verificar o <a href="../01-tools/exceptions/index.html">tratamento correto de exceções</a> e o <a href="../01-tools/java-synch/index.html">acesso sincronizado a dados partilhados</a></li>
</ul>
<ul>
    <li>Preparar o <b>guião de demonstração</b> (secção 4.8 do <a href="../proj/enunciado-proj-SD-1718.pdf#page=9">enunciado</a>)</li>
    <ul>
        <li>Caso F1: funcionamento normal da replicacão</li>
        <li>Caso F2: tolerância a falta</li>
    </ul>
</ul>

<p>
&nbsp;
</p>

<p>
<b>Bom trabalho!</b>
</p>

<p>
&nbsp;
</p>

</div>

<hr />


<div class="rodape">
<p>
&copy; Docentes de Sistemas Distribuídos,
<a href="http://www.dei.tecnico.ulisboa.pt/">Dep. Eng. Informática</a>,
<a href="http://www.ist.eu">Técnico Lisboa</a><br />
</p>
</div>

</body></html>
