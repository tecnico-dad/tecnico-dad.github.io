<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
      <link rel="stylesheet" type="text/css" href="../_css/labs-sd.css">
      <link href="../_prettify/prettify.css" type="text/css" rel="stylesheet" />
      <script type="text/javascript" src="../_prettify/prettify.js"></script>
      <title>gRPC Multi-linguagem</title>
   </head>
   <body onload="prettyPrint()">
      <div class="contexto">
         <p>
            <a href="../index.html">Labs SD</a> &gt;
         </p>
      </div>
      <div class="titulo" id="1">
         <h1>gRPC Multi-linguagem</h1>
      </div>
      <div class="objectivos">
         <h2>Objetivos</h2>
         <ul>
            <li>Comunicação client-servidor com múltiplas linguagens de programação</li>
         </ul>
      </div>
      <div class="indice"></div>
      <div class="corpo">
      <h2 id="materiais-de-apoio-aula">Materiais de apoio à aula</h2>
      <ul>
         <li><a href="https://grpc.io/docs/languages/python/basics/">https://grpc.io/docs/languages/python/basics/</a></li>
      </ul>
      <h2 id="pr-requisitos">Pré-requisitos</h2>
      <ul>
         <li>Python 3.5+</li>
         <li>Packages: grpcio, grpcio-tools</li>
      </ul>
      <h2 id="setup-e-instala-o-das-packages">Setup e instalação das packages</h2>
      <pre class="prettyprint lang-java"><span class="hljs-comment"># windows</span>
 &gt; python -m venv venv
 &gt; venv\Scripts\activate

 <span class="hljs-comment"># linux</span>
 $ python -m pip <span class="hljs-keyword">install</span> virtualenv 
 $ virtualenv .venv
 $ source .venv/bin/activate

 python -m pip <span class="hljs-keyword">install</span> grpcio
 python -m pip <span class="hljs-keyword">install</span> grpcio-tools

 deactivate
</pre>
      <h2 id="compila-o-do-proto">Compilação do proto</h2>
      <ul>
         <li>
            <pre class="prettyprint lang-java">python -m grpc_tools.protoc -I&lt;pasta-para-o-contrato&gt; --python_out=&lt;diretoria-output&gt; --grpc_python_out=&lt;diretoria-output&gt; &lt;protos-para-compilar&gt;</pre>
         </li>
         <li>Confirmar que 2 ficheiros .py foram gerados na diretoria-output indicada, &lt;nome-do-proto&gt;_pb2.py e &lt;nome-do-proto&gt;_pb2_grpc.py</li>
      </ul>
      <h2 id="java-vs-python-grpc">Java vs Python gRPC</h2>
      <ul>
         <li>
            Fazer <strong>Clone</strong> ou <strong>Download</strong> do código fonte do <a href="https://github.com/tecnico-distsys/example_grpc_multilanguage">grpc_example_multilanguage</a>.
            <ul>
               <li>Executar e testar o código:</li>
               <li>Criar um virtual env na diretoria base seguindo as instruções dadas na secção &quot;Setup e instalação das packages&quot;.</li>
               <li>Na diretoria contract, compilar e executar os seguintes comandos: <code>mvn install; mvn exec:exec</code>.</li>
               <li>Analisar a diretoria generated-sources/protobuf e ver o código gerado nas diretorias java e python.</li>
               <li>Testar server: na diretoria server executar: <code>mvn compile exec:java</code></li>
               <li>Testar python_client: na diretoria python_client executar <code>python client.py</code></li>
            </ul>
         </li>
         <li>
            <p>Analisar as diferenças e as semelhanças entre os dois clientes:</p>
            <ol>
               <li>
                  <p>Criação de stubs:</p>
                  <ul>
                     <li>
                        Java:
                        <pre class="prettyprint lang-java">  final ManagedChannel channel = ManagedChannelBuilder.forTarget(target).usePlaintext().build()<span class="hljs-comment">;</span>
  HelloWorldServiceGrpc.HelloWorldServiceBlockingStub stub = HelloWorldServiceGrpc.newBlockingStub(channel)<span class="hljs-comment">;</span>
</pre>
                     </li>
                     <li>
                        Python:
                        <pre class="prettyprint lang-java">  <span class="hljs-keyword">with</span> grpc.insecure_channel(<span class="hljs-string">'localhost:8080'</span>) <span class="hljs-keyword">as</span> channel:
      stub = pb2_grpc.HelloWorldServiceStub(channel)
</pre>
                     </li>
                  </ul>
               </li>
               <li>
                  <p>Chamadas aos procedimentos remotos:</p>
                  <ul>
                     <li>
                        Java:
                        <pre class="prettyprint lang-java">  HelloWorld.HelloRequest <span class="hljs-built_in">request</span> = HelloWorld.HelloRequest.newBuilder().setName(<span class="hljs-string">"friend"</span>).build();
  HelloWorld.HelloResponse <span class="hljs-built_in">response</span> = stub.greeting(<span class="hljs-built_in">request</span>);
</pre>
                     </li>
                     <li>
                        Python:
                        <pre class="prettyprint lang-java">  response = stub.greeting(pb2.HelloRequest(<span class="hljs-keyword">name</span>=<span class="hljs-string">'friend'</span>))
</pre>
                     </li>
                  </ul>
               </li>
            </ol>
         </li>
      </ul>
      <h2 id="exerc-cio">Exercício</h2>
      <ul>
         <li>Fazer <strong>Clone</strong> ou <strong>Download</strong> do código fonte <a href="https://github.com/tecnico-distsys/example_grpc_addressbook">example grpc addressbook</a></li>
         <li>No código base fornecido, o servidor mantém uma lista de contactos e permite ao cliente adicionar novos contactos e listar contactos.</li>
         <li>O objetivo deste exercício é extender o comportamento da aplicação base de modo a permitir que cliente possa procurar contactos.</li>
         <li>Procedimentos remotos a implementar: <code>searchPerson</code></li>
         <li>
            searchPerson recebe uma <code>string</code> que corresponde ao email do contacto e retorna a informação que o servidor tem desse contacto.
            <ul>
               <li>Erros: o servidor não tem informação do contacto indicado</li>
            </ul>
         </li>
      </ul>
      <ol>
         <li>Comece por criar um virtual env na diretoria base seguindo as instruções da secção &quot;Setup e instalação das packages&quot;.</li>
         <li>
            <p>Definir, implementar e experimentar o procedimento remoto searchPerson no contract</p>
            <ul>
               <li>
                  Existem três módulos: contract, server e client. Vamos começar pelo contrato:
                  <ol>
                     <li>Aceder ao ficheiro .proto. Este ficheiro define as estruturas de dados e os procedimentos remotos.</li>
                     <li>
                        Cada procedimento necessita de uma mensagem de pedido e de uma mensagem de resposta.
                        <ul>
                           <li>Definir a mensagem do pedido, SearchPersonRequest, que uma string que corresponde ao email do contacto a pesquisar.</li>
                           <li>Definir o procedimento rpc com o nome searchPerson, que recebe SearchPersonRequest e devolve PersonInfo.</li>
                        </ul>
                     </li>
                     <li>
                        Vamos gerar código Java a partir dos protocol buffers. O Maven está configurado com plugins para chamar a ferramenta protoc (protocol buffers compiler)
                        <ul>
                           <li>Executar: mvn install </li>
                           <li>Se tudo correr bem, as definições protobuf foram convertidas para classes Java, que foram compiladas e instaladas no repositório local do Maven.</li>
                        </ul>
                     </li>
                     <li>
                        Vamos gerar código Python a partir dos protocol buffers.
                        <ul>
                           <li>Executar: mvn exec:exec</li>
                           <li>Verificar e analisar os ficheiros gerados na diretoria generated-sources/protobuf/python: AddressBook_pb2_grpc.py e AddressBook_pb2.py</li>
                        </ul>
                     </li>
                  </ol>
               </li>
               <li>
                  Vamos agora concretizar o servidor:
                  <ul>
                     <li>
                        Com base nas classes geradas pelo protoc e, por analogia com outros exemplos de servidores gRPC já vistos nas aulas, adicione a AddressBookServiceImpl e adicione o método de implementação do searchPerson: 
                        <pre class="prettyprint lang-java">   <span class="hljs-meta">@Override</span>
   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">searchPerson</span><span class="hljs-params">(SearchPersonRequest request, StreamObserver&lt;PersonInfo&gt; responseObserver)</span> </span>{
       \\TODO
   }
</pre>
                     </li>
                     <li>Para compilar e testar, executar na diretoria server: <code>mvn compile exec:java</code></li>
                  </ul>
               </li>
               <li>
                  <p>Vamos concretizar o cliente:</p>
                  <ul>
                     <li>
                        <p>Adicionar uma função ao PythonClient que pede o email a procurar e chamada o procedimento remoto <code>searchPerson</code></p>
                        <pre class="prettyprint lang-java">   <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PyhtonClient</span><span class="hljs-params">(object)</span>:</span>
   ...
   <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">search_person</span><span class="hljs-params">(self)</span>:</span>
       <span class="hljs-comment"># TODO</span>

   ...
   <span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
       ...
       <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">'3'</span>:
           client.search_person()
</pre>
                     </li>
                     <li>Para testar, executar na diretoria client: <code>python client.py</code></li>
                  </ul>
               </li>
            </ul>
         </li>
      </ol>
      <p>O resto do enunciado será entregue na aula.
         O objectivo será estender a solução criando novos procedimentos remotos.
      </p>
      <p>&nbsp;</p>
      <hr />
      <div class="rodape">
         <p>
            &copy; Docentes de Sistemas Distribuídos,
            <a href="http://www.dei.tecnico.ulisboa.pt/">Dep. Eng. Informática</a>,
            <a href="http://www.ist.eu">Técnico Lisboa</a><br />
         </p>
      </div>
   </body>
</html>