<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../_css/labs-sd.css" />

    <link href="../_prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../_prettify/prettify.js"></script>

    <title>Invocação de procedimentos remotos com a API REST</title>
</head>

<body onload="prettyPrint()">
    <div class="contexto">
        <p><a href="../index.html">Labs SD</a> &gt;</p>
    </div>

    <div class="titulo" id="1">
        <h1>Invocação de procedimentos remotos com REST</h1>
    </div>

    <div class="objectivos">
        <h2>Objectivos da semana</h2>
        <ul>
            <li>
                Distribuir uma aplicação originalmente centralizada usando REST
            </li>
            <li>
                Descrever, em detalhe, os componentes REST
            </li>
        </ul>
    </div>

    <div class="indice"></div>

    <div class="corpo">
        <h2 id="conteudos">Materiais de apoio à aula</h2>

        <p class="exemplos"></p>
        <ul>
            <li>
                <a href="./hello-rest.zip">REST Hello World <img src="../_img/zip.png" alt="ZIP" /></a>
                <br /> Siga as instruções dos ficheiros <tt>README.md</tt> para compilar e executar o exemplo.
            </li>
        </ul>
        <ul>
            <li>
                <a href="https://www.codecademy.com/articles/what-is-rest">Texto resumido sobre o que é REST</a>
            </li>
            <li>
                <a href="https://restfulapi.net/">Tutorial sobre REST</a>
            </li>
            <li>
                <a href="https://eclipse-ee4j.github.io/jersey/">REST em Java (Jersey)</a>
            </li>
        </ul>
        <p>&nbsp;</p>

        <p class="exercicios"></p>
        <h2 id="guiao">Exercício a resolver até ao fim da aula</h2>

        <p>
            Neste exercício iremos transformar uma implementação do Jogo do Galo (<i>Tic Tac Toe</i>) numa aplicação distribuída utilizando REST.
        </p>

        <img src="./ttt.png" alt="Tic Tac Toe" height="90" />
        <br />

        <p>
            Partindo de uma versão Jogo do Galo feita para um cenário local, pretende-se desenvolver uma variante do jogo onde a parte computacionalmente mais pesada é realizada por um servidor remoto. O servidor guarda as variáveis do jogo. O cliente faz a interface com o utilizador.
            <br />
        </p>

        <ol type="I">
            <li>
                Jogo do Galo/<i>Tic Tac Toe</i>
            </li>
            <ol type="1">
                <li>
                    Descarregue e descomprima o código fonte da <a href="./ttt-local.zip">implementação do jogo <img src="../_img/zip.png" alt="ZIP" /></a>.
                </li>
                <li>
                    Analise o código do jogo de forma a compreender a implementação.
                </li>
                <li>
                    Compile e execute o código com o comando:
                    <br />
                    <tt>mvn compile exec:java</tt>
                    <br />
                </li>
                <li>
                    Experimente o jogo. Indique a posição escolhida para cada jogador, até terminar o jogo.
                    <br />
                    <br />
                </li>
            </ol>

            <li>
                Pretende-se que a nova versão do programa seja dividida em dois processos: servidor e cliente, através do Jersey.
                <br /> Descarregue e descomprima o <a href="./ttt-rest-initial.zip">código fonte da aplicação
    Jogo do Galo/Tic Tac Toe <img src="../_img/zip.png" alt="ZIP"></a> adaptada a este exercício.
                <br />
            </li>
            <ol type="1">
                <li>
                    Veja como o programa está estruturado em dois módulos: <i>server</i> e <i>client</i>.
                    <br /> Cada módulo tem um POM próprio.
                </li>
                <li>
                    Importe os projectos no Eclipse, recorrendo a <i> File &gt; Import &gt; Maven &gt; Existing Maven Projects</i>
                </li>
                <li>
                    Nesta secção, vamo-nos focar apenas no <i>server</i>. O <i>client</i> já está todo implementado e vai ser utilizado para testar e jogar o jogo do galo na secção a seguir.
                </li>
                <li>Estude os principais ficheiros com a implementação do jogo (
                    <tt>TTTGame.java</tt>, <tt>TTTResources.java</tt> e <tt>PlayRequest.java</tt> do módulo <i>server</i>).
                    <ol type="a">
                        <li>
                            Analise o ficheiro <tt>TTTGame.java</tt> e perceba como funciona o jogo do galo</a>.
                        </li>
                        <li>
                            O ficheiro <tt>TTTResources.java</tt> contêm dois métodos GET. Analise o que cada um faz.
                        </li>
                        <li>
                            O ficheiro <tt>PlayRequest.java</tt> contêm a informação necessária para fazer uma jogada (row, column e player). Existe um decorador <tt>@XmlRootElement</tt>. Qual é a necessidade desta linha de código?
                        </li>
                    </ol>
                </li>
                <li>
                    Compile o servidor utilizando <kbd>mvn compile exec:java</kbd>.
                </li>
                <li>
                    Abra o browser e aceda a <tt>http://localhost:8080/ttt/game/board</tt>. Confirme que o que aparece no ecrâ é um tabuleiro do jogo do galo.
                    <br />
                    <br />
                </li>
            </ol>

            <li>
                Vamos agora implementar os métodos necessários para que o Jogo do Galo funcione numa aplicação cliente-servidor com REST, organizada em dois módulos,.
                <br />
                <br />
            </li>
            <ol type="1">
                <li>
                    Baseando-se no ficheiro <tt>TTTResources.java</tt> da aplicação, crie um método GET para verificar qual o jogador que ganhou, utilizando o método <tt>checkWinner</tt>. <br/>Sugestão: olhe para os métodos <tt>getBoard</tt> e <tt>resetBoard</tt>.
                    <br/>
                </li>
                <ol type="a">
                    <li>
                        O pedido deve ser acedido no caminho <tt>"board/checkwinner"</tt>, para manter consistência com os outros métodos já disponíveis.
                    </li>
                    <li>
                        Verifique sempre se o caminho funciona (depois de compilar e executar), acedendo com o browser.
                    </li>
                    <li>
                        O que é devolvido do pedido está no formato texto (<tt>MediaType.TEXT_PLAIN</tt>), mas o que o método devolve é um inteiro. E se, em vez de texto, fosse pedido XML? E se fosse JSON?
                        <br />
                        <br />
                    </li>
                </ol>
                <li>
                    Agora é necessária uma maneira de jogar, isto é, invocar o método <tt>play</tt> a partir de um cliente. Para isso é necessário criar um método POST para enviar um pedido que contêm a jogada que queremos efetuar.
                    <ol type="a">
                        <li>
                            Comece por analisar novamente o método <tt>play</tt> do ficheiro <tt>TTTGame.java</tt> e o ficheiro <tt>PlayRequest.java</tt>.
                        </li>
                        <li>
                            No ficheiro <tt>TTTResources.java</tt>, crie um método POST no caminho <tt>"play"</tt> que receba um <tt>PlayRequest</tt> em JSON e que produza um <tt>PlayResult</tt> em JSON. Este método vai-nos permitir enviar jogadas para o servidor.
                            <br /> Exemplo de um método que recebe qualquer coisa em XML e JSON e devolve qualquer coisa em XML:
                            <pre class="prettyprint lang-java">
    @POST
    @Path("caminho-aqui")
    @Consumes({MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON})
    @Produces({MediaType.APPLICATION_XML})
    public QualquerCoisa metodo(ClasseCoisa coisa) {
        return qualquerCoisa;
    }

                        </li>
                        <li>
                            Depois de terminado, compile o servidor utilizando <kbd>mvn clean install</kbd>
                        </li>
                        <li>
                            Aceda agora à pasta que contêm o cliente. Compile o cliente utilizando <kbd>mvn clean compile</kbd>
                        </li>
                        <ol type="i">
                            <li>
                                Porque é que a compilação falhou? Porque é que o maven não consegue encontrar aquelas classes?
                                <br />
                                <br />
                            </li>
                        </ol>
                        <li>
                            O cliente necessita de obter informação acerca de algumas classes que estão definidas no servidor. 
                            <br />Para isso, é necessário criar uma dependência do servidor no cliente:

        <pre class="prettyprint lang-xml prettyprinted" style=""><span class="pln">    ...
        </span><span class="tag">&lt;dependency&gt;</span><span class="pln">
            </span><span class="tag">&lt;groupId&gt;</span><span class="pln">pt.ulisboa.tecnico.distsys.ttt-rest</span><span class="tag">&lt;/groupId&gt;</span><span class="pln">
            </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">ttt-server</span><span class="tag">&lt;/artifactId&gt;</span><span class="pln">
            </span><span class="tag">&lt;version&gt;</span><span class="pln">0.0.1-SNAPSHOT</span><span class="tag">&lt;/version&gt;</span><span class="pln">
        </span><span class="tag">&lt;/dependency&gt;</span><span class="pln">
    ...</span></pre>
                        </li>
                        <li>
                            Compile novamente o cliente e confirme que foi bem sucedido.
                            <br/>
                            <br/>
                        </li>
                    </ol>
                </li>
            </ol>
            </li>
            <li>
                Acima enviamos os parâmetros do método <tt>play</tt> utilizando um método POST em REST. Agora vamos enviar os argumentos encapsulando parâmetros no URL.
                <br />
                <br />
                <ol type="1">
                    <li>
                        Para isso vamos criar outro método GET no ficheiro <tt>TTTResources.java</tt>.
                    </li>
                    <ol type="a">
                        <li>
                            Usando o código do ficheiro <tt>TTTResources.java</tt> do código base e o exemplo imediatamente abaixo, crie um método GET que permita enviar os argumentos utilizando parâmetros URL.
                            <br /> Exemplo de utilização:
                            <pre class="prettyprint lang-java">
    @GET
    @Path("{arg1}/{arg2}")
    @Produces(...)
    public QualquerCoisa metodo(@PathParam("arg1") int arg1,
                     @PathParam("arg2") String arg2) {
        return qualquerCoisa.fazcoisas(arg1, arg2);
    }

                </pre>
                        </li>
                        <li>
                            Para testar a sua implementação, abra o browser e aceda a <tt>http://localhost:8080/ttt/game/board/reset</tt> para reiniciar o jogo.
                        </li>

                        <li>
                            Para fazer uma jogada, experimente, por exemplo, <tt>http://localhost:8080/ttt/game/play/1/1/0</tt>.
                        </li>
                        <li>
                            Se tudo correu bem, ao aceder agora a <tt>http://localhost:8080/ttt/game/board</tt>, o tabuleiro com a jogada anterior vai aparecer no ecrâ.
                            <br/>
                            <br/>
                        </li>

                    </ol>
                    <li>
                        O cliente está configurado para utilizar o método POST em vez do novo método GET para jogar. Para isso é necessário fazer algumas alterações.
                        <ol type="a">
                        <li>
                            Vá agora ao cliente e no ficheiro <tt>TTTPlayer.java</tt> comente as linhas seguintes desta forma:
                            <pre class="prettyprint lang-java">
    /* Response response = client.target(restURL).path("play").request(MediaType.APPLICATION_JSON)
    .post(Entity.entity(playRequest, MediaType.APPLICATION_JSON), Response.class); */

    ...

    /* play_res = response.readEntity(PlayResult.class); */
                    </pre>
                        </li>
                        <li>
                            Descomente a linha seguinte desta forma:
                            <pre class="prettyprint lang-java">
    /* Uncomment to use URL parameter to play */
    /* URL to play is: play/{row}/{column}/{player} */
    String playString = "play/" +  String.valueOf(row) + '/' + String.valueOf(column) + '/' + String.valueOf(player);
                    </pre>
                        </li>
                        <li>
                            Finalmente, só precisamos de aceder ao URL que vai fazer a jogada e receber o resultado da jogada. Para isso, adicione a linha de código da seguinte forma:
                            <pre class="prettyprint lang-java">
    play_res = client.target(restURL).path(playString).request().get(PlayResult.class);
                    </pre>
                        </li>
                    </ol>
            </li>
            </ol>

            <p>
                O resto do enunciado será entregue na aula.
                <br /> O objectivo será estender a solução resultante do enunciado acima com mais procedimentos remotos ou modificar alguns dos seus procedimentos actuais.
                <br />
                <br />
            </p>
    </div>

    <div class="objectivos">
        <h2>Entrega da solução</h2>

        <p>Fénix, Avaliação, Projetos, <b>mini Exercício 1 - REST</b></p>

        <p>
            A solução completa deverá ser submetida no Fénix
            <b>antes do fim da sua aula de laboratório</b>.
            <br /> Trabalhos submetidos depois da hora de fim da aula não serão considerados.
            <br />
        </p>

        <p>
            <b>Ter atenção ao seguinte:</b>
        </p>
        <ul>
            <li>
                Só serão aceites trabalhos de estudantes que estiveram presentes no laboratório.
            </li>
            <li>
                Assegure-se que a solução é enviada em formato ZIP e que não contém código compilado (faça <tt>mvn clean</tt> antes de criar o zip)
            </li>
            <li>
                Deverá também incluir um ficheiro <tt>README</tt> com resumo da funcionalidade implementada e com instruções para colocar o programa a funcionar como esperado.
                <br /> Por exemplo:
            </li>
            <ul>
                <li>
                    A funcionalidade pedida foi total/parcialmente implementada
                    <b>...</b>
                </li>
                <li>Para compilar: <kbd>mvn compile</kbd></li>
                <li>
                    O servidor deve executar com o comando:
                    <kbd>mvn exec:java &amp;</kbd>
                </li>
                <li>
                    O cliente deve executar com o comando:
                    <kbd>mvn exec:java</kbd>
                </li>
            </ul>
        </ul>
    </div>

    <hr />

    <div class="rodape">
        <p>
            &copy; Docentes de Sistemas Distribu&iacute;dos,
            <a href="http://www.dei.tecnico.ulisboa.pt/">Dep. Eng. Informática</a>,
            <a href="http://www.ist.eu">Técnico Lisboa</a>
            <br />
        </p>
    </div>
</body>

</html>